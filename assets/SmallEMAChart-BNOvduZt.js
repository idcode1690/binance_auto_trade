import{r as m,j as u}from"./index-BYMkoTQ0.js";function st(M,N){const $=2/(N+1),b=[];let p=null;for(let g=0;g<M.length;g++){const x=M[g];if(x==null){b.push(null);continue}p==null?p=x:p=x*$+p*(1-$),b.push(p)}return b}function mt({interval:M="1m",limit:N=200,livePrice:$=null,onTrade:b=null,onCross:p=null,emaShort:g=26,emaLong:x=200,symbol:E="BTCUSDT"}){const[h,C]=m.useState([]),[ct,W]=m.useState(!0),[F,z]=m.useState([]),[L,Z]=m.useState([]),Y=m.useRef(null),B=m.useRef(null);m.useEffect(()=>{let t=!1,s=null;async function n(){W(!0);try{const e=`klines:${String(E).toUpperCase()}:${M}:L${N}`,o=1e3*60*5;try{const c=localStorage.getItem(e);if(c){const f=JSON.parse(c);if(f&&Array.isArray(f.data)&&f.ts&&Date.now()-f.ts<o){C(f.data),W(!1);return}}}catch{}const r=`https://api.binance.com/api/v3/klines?symbol=${encodeURIComponent(E)}&interval=${M}&limit=${N}`,a=(await(await fetch(r)).json()).map(c=>({open:parseFloat(c[1]),high:parseFloat(c[2]),low:parseFloat(c[3]),close:parseFloat(c[4]),closed:!0,time:c[0]}));if(t)return;C(a);try{localStorage.setItem(e,JSON.stringify({ts:Date.now(),data:a}))}catch{}W(!1)}catch(e){console.warn("fetch klines failed",e),C([]),W(!1)}}try{const e=String(E||"BTCUSDT").toLowerCase(),r=`wss://stream.binance.com:9443/stream?streams=${`${e}@kline_${M}/${e}@trade`}`;s=new WebSocket(r),s.onmessage=l=>{try{const i=JSON.parse(l.data),a=i.data||i;if(a&&a.k){const c=a.k,f={open:parseFloat(c.o),high:parseFloat(c.h),low:parseFloat(c.l),close:parseFloat(c.c),time:c.t,closed:!!c.x};C(d=>{if(!d||d.length===0)return[f];if(d[d.length-1].time===f.time){const R=d.slice(0,d.length-1);return R.push(f),R}else{const R=d.concat([f]);return R.length>N&&R.shift(),R}});return}if(a&&(a.p||a.price)){const c=parseFloat(a.p||a.price||a.P);if(b&&isFinite(c))try{b(c)}catch{}}}catch{}},s.onerror=l=>console.warn("combined ws error",l)}catch(e){console.warn("failed to open combined websocket",e)}return n(),()=>{t=!0;try{s&&s.close()}catch{}}},[M,N,E,b]),m.useEffect(()=>{if(!h||h.length===0)return;const t=h.map(e=>e.close),s=st(t,g),n=st(t,x);z(s),Z(n),Y.current=s.length?s[s.length-1]:null,B.current=n.length?n[n.length-1]:null},[h,g,x]);const P=m.useRef(null),A=m.useRef(null);m.useEffect(()=>{if($==null)return;const t=Number($);if(isFinite(t))return P.current=t,A.current==null&&(A.current=requestAnimationFrame(()=>{const s=P.current;P.current=null,A.current=null,C(n=>{if(!n||n.length===0)return n;const e=n.slice(),o=e[e.length-1];if(!o)return n;const r={...o,close:s,high:Math.max(o.high,s),low:Math.min(o.low,s)};return e[e.length-1]=r,e});try{if(Y.current!=null&&B.current!=null){const n=2/(g+1),e=2/(x+1),o=s*n+Y.current*(1-n),r=s*e+B.current*(1-e);Y.current=o,B.current=r,z(l=>{if(!l||l.length===0)return l;const i=l.slice();return i[i.length-1]=o,i}),Z(l=>{if(!l||l.length===0)return l;const i=l.slice();return i[i.length-1]=r,i})}}catch{}})),()=>{A.current&&(cancelAnimationFrame(A.current),A.current=null)}},[$]);const T=600,_=160,w=2,D=h.length,[S,ot]=m.useState(120),U=10,O=Math.max(U,N),y=Math.min(D,S),v=h.slice(-y),J=F.slice(-y),K=L.slice(-y),lt=m.useCallback(t=>{try{t.preventDefault()}catch{}const s=t.deltaY,n=Math.max(1,Math.round(S*.12));let e=S;if(s<0)e=Math.max(U,S-n);else if(s>0){const o=Math.min(Math.max(U,D||0),O);e=Math.min(o,S+n)}e!==S&&ot(e)},[S,U,O,D]),at=y>U,rt=y<Math.min(D,O),q=m.useRef(new Set);m.useEffect(()=>{if(!p||!F||!L)return;const t=h&&h.length>0?h[h.length-1]:null;if(!t||!t.closed)return;const s=Math.min(F.length,L.length);if(s<2)return;const n=s-1,e=F[n-1],o=L[n-1],r=F[n],l=L[n];if(r==null||l==null||e==null||o==null)return;const i=e-o,a=r-l;let c=null;if(i<=0&&a>0?c="bull":i>=0&&a<0&&(c="bear"),c){const f=h&&h.length>0?h[h.length-1].time:Date.now(),d=`${f}:${c}`;if(!q.current.has(d)){q.current.add(d);try{p({type:c,time:f,price:h[h.length-1].close})}catch{}}}},[F,L,p,h]);const H=v.map(t=>Number(t.high)).filter(t=>isFinite(t)),G=v.map(t=>Number(t.low)).filter(t=>isFinite(t));if(H.length===0||G.length===0)return ct?u.jsx("div",{className:"meta",children:"Loading chart..."}):u.jsxs("div",{className:"meta",children:["No data for ",String(E)]});const it=Math.max(...H),Q=Math.min(...G);let k=(T-w*2)/(y-1||1),I=Math.max(1,k*.6);const X=w,ut=Math.max(w,Math.ceil(I/2)+1);k=(T-X-ut)/(y-1||1),I=Math.max(1,k*.6);const j=t=>w+(1-(t-Q)/(it-Q||1))*(_-w*2),tt=t=>{let s="";for(let n=0;n<t.length;n++){const e=t[n];if(e==null)continue;const o=w+n*k,r=j(e);s+=s===""?`M ${o} ${r}`:` L ${o} ${r}`}return s},et=tt(J),nt=tt(K),V=[];for(let t=1;t<y;t++){const s=J[t-1],n=K[t-1],e=J[t],o=K[t];if(e==null||o==null||s==null||n==null)continue;const r=s-n,l=e-o;if(r<=0&&l>0){const i=w+t*k,a=j((e+o)/2);V.push({x:i,y:a,type:"bull",idx:t})}else if(r>=0&&l<0){const i=w+t*k,a=j((e+o)/2);V.push({x:i,y:a,type:"bear",idx:t})}}return D===0?u.jsx("div",{className:"meta",children:"Loading chart..."}):u.jsxs("div",{onWheel:lt,style:{width:"100%",overflow:"hidden",cursor:at?"zoom-in":rt?"zoom-out":"default"},children:[u.jsxs("svg",{className:"chart-svg",viewBox:`0 0 ${T} ${_}`,preserveAspectRatio:"xMidYMid meet",style:{width:"100%",height:"auto",display:"block"},children:[v.map((t,s)=>{if(![t.open,t.high,t.low,t.close].every(d=>isFinite(Number(d))))return null;const n=X+s*k,e=j(t.high),o=j(t.low),r=j(t.open),l=j(t.close),a=t.close>=t.open?"#0f9d58":"#d93025",c=Math.min(r,l),f=Math.max(1,Math.abs(l-r));return u.jsxs("g",{children:[u.jsx("line",{x1:n,x2:n,y1:e,y2:o,stroke:a,strokeWidth:1}),u.jsx("rect",{x:n-I/2,y:c,width:I,height:f,fill:a})]},t.time)}),nt&&u.jsx("path",{className:"ema200",d:nt,fill:"none",stroke:"#888",strokeWidth:1.2}),et&&u.jsx("path",{className:"ema26",d:et,fill:"none",stroke:"#ff9900",strokeWidth:1.6}),V.map((t,s)=>u.jsx("circle",{className:"cross-marker "+(t.type==="bull"?"bull":"bear"),cx:t.x,cy:t.y,r:4},s))]}),u.jsxs("div",{className:"chart-legend",children:[u.jsxs("span",{className:"legend-item",children:[u.jsx("span",{className:"swatch ema26"}),`EMA${g}`]}),u.jsxs("span",{className:"legend-item",children:[u.jsx("span",{className:"swatch ema200"}),`EMA${x}`]}),u.jsxs("span",{className:"legend-item",children:[u.jsx("span",{className:"swatch bull"}),"Bull Cross"]}),u.jsxs("span",{className:"legend-item",children:[u.jsx("span",{className:"swatch bear"}),"Bear Cross"]})]})]})}export{mt as default};
