import{r as f,j as u}from"./index-xAVIvdBC.js";function at(M,N){const L=2/(N+1),b=[];let p=null;for(let g=0;g<M.length;g++){const x=M[g];if(x==null){b.push(null);continue}p==null?p=x:p=x*L+p*(1-L),b.push(p)}return b}function pt({interval:M="1m",limit:N=200,livePrice:L=null,onTrade:b=null,onCross:p=null,emaShort:g=26,emaLong:x=200,symbol:D="BTCUSDT"}){const[h,U]=f.useState([]),[ot,W]=f.useState(!0),[A,_]=f.useState([]),[E,q]=f.useState([]),Y=f.useRef(null),B=f.useRef(null);f.useEffect(()=>{let t=!1,s=null;async function n(){W(!0);try{const e=`klines:${String(D).toUpperCase()}:${M}:L${N}`,a=1e3*60*5;try{const c=localStorage.getItem(e);if(c){const m=JSON.parse(c);if(m&&Array.isArray(m.data)&&m.ts&&Date.now()-m.ts<a){U(m.data),W(!1);return}}}catch{}const r=`https://api.binance.com/api/v3/klines?symbol=${encodeURIComponent(D)}&interval=${M}&limit=${N}`,l=(await(await fetch(r)).json()).map(c=>({open:parseFloat(c[1]),high:parseFloat(c[2]),low:parseFloat(c[3]),close:parseFloat(c[4]),closed:!0,time:c[0]}));if(t)return;U(l);try{localStorage.setItem(e,JSON.stringify({ts:Date.now(),data:l}))}catch{}W(!1)}catch(e){console.warn("fetch klines failed",e),U([]),W(!1)}}try{const e=String(D||"BTCUSDT").toLowerCase(),r=`wss://stream.binance.com:9443/stream?streams=${`${e}@kline_${M}/${e}@trade`}`;s=new WebSocket(r),s.onmessage=o=>{try{const i=JSON.parse(o.data),l=i.data||i;if(l&&l.k){const c=l.k,m={open:parseFloat(c.o),high:parseFloat(c.h),low:parseFloat(c.l),close:parseFloat(c.c),time:c.t,closed:!!c.x};U(d=>{if(!d||d.length===0)return[m];if(d[d.length-1].time===m.time){const C=d.slice(0,d.length-1);return C.push(m),C}else{const C=d.concat([m]);return C.length>N&&C.shift(),C}});return}if(l&&(l.p||l.price)){const c=parseFloat(l.p||l.price||l.P);if(b&&isFinite(c))try{b(c)}catch{}}}catch{}},s.onerror=o=>console.warn("combined ws error",o)}catch(e){console.warn("failed to open combined websocket",e)}return n(),()=>{t=!0;try{s&&s.close()}catch{}}},[M,N,D,b]),f.useEffect(()=>{if(!h||h.length===0)return;const t=h.map(e=>e.close),s=at(t,g),n=at(t,x);_(s),q(n),Y.current=s.length?s[s.length-1]:null,B.current=n.length?n[n.length-1]:null},[h,g,x]);const T=f.useRef(null),R=f.useRef(null);f.useEffect(()=>{if(L==null)return;const t=Number(L);if(isFinite(t))return T.current=t,R.current==null&&(R.current=requestAnimationFrame(()=>{const s=T.current;T.current=null,R.current=null,U(n=>{if(!n||n.length===0)return n;const e=n.slice(),a=e[e.length-1];if(!a)return n;const r={...a,close:s,high:Math.max(a.high,s),low:Math.min(a.low,s)};return e[e.length-1]=r,e});try{if(Y.current!=null&&B.current!=null){const n=2/(g+1),e=2/(x+1),a=s*n+Y.current*(1-n),r=s*e+B.current*(1-e);Y.current=a,B.current=r,_(o=>{if(!o||o.length===0)return o;const i=o.slice();return i[i.length-1]=a,i}),q(o=>{if(!o||o.length===0)return o;const i=o.slice();return i[i.length-1]=r,i})}}catch{}})),()=>{R.current&&(cancelAnimationFrame(R.current),R.current=null)}},[L]);const O=600,[v,mt]=f.useState(!0),H=v?266:154,w=2,S=h.length,[k,J]=f.useState(80),j=10,I=Math.max(j,N),y=Math.min(S,k),K=h.slice(-y),V=A.slice(-y),z=E.slice(-y),lt=f.useCallback(t=>{try{t.preventDefault()}catch{}const s=t.deltaY,n=Math.max(1,Math.round(k*.12));let e=k;if(s<0)e=Math.max(j,k-n);else if(s>0){const a=Math.min(Math.max(j,S||0),I);e=Math.min(a,k+n)}e!==k&&J(e)},[k,j,I,S]),rt=y>j,it=y<Math.min(S,I);f.useEffect(()=>{S&&J(v?t=>Math.max(j,Math.round(t*.6)):t=>Math.min(Math.max(j,S||0,I),Math.round(t/.6)))},[v]);const G=f.useRef(new Set);f.useEffect(()=>{if(!p||!A||!E)return;const t=h&&h.length>0?h[h.length-1]:null;if(!t||!t.closed)return;const s=Math.min(A.length,E.length);if(s<2)return;const n=s-1,e=A[n-1],a=E[n-1],r=A[n],o=E[n];if(r==null||o==null||e==null||a==null)return;const i=e-a,l=r-o;let c=null;if(i<=0&&l>0?c="bull":i>=0&&l<0&&(c="bear"),c){const m=h&&h.length>0?h[h.length-1].time:Date.now(),d=`${m}:${c}`;if(!G.current.has(d)){G.current.add(d);try{p({type:c,time:m,price:h[h.length-1].close})}catch{}}}},[A,E,p,h]);const Q=K.map(t=>Number(t.high)).filter(t=>isFinite(t)),X=K.map(t=>Number(t.low)).filter(t=>isFinite(t));if(Q.length===0||X.length===0)return ot?u.jsx("div",{className:"meta",children:"Loading chart..."}):u.jsxs("div",{className:"meta",children:["No data for ",String(D)]});const ut=Math.max(...Q),tt=Math.min(...X);let $=(O-w*2)/(y-1||1),P=Math.max(1,$*.6);const et=w,ht=Math.max(w,Math.ceil(P/2)+1);$=(O-et-ht)/(y-1||1),P=Math.max(1,$*.6);const F=t=>w+(1-(t-tt)/(ut-tt||1))*(H-w*2),nt=t=>{let s="";for(let n=0;n<t.length;n++){const e=t[n];if(e==null)continue;const a=w+n*$,r=F(e);s+=s===""?`M ${a} ${r}`:` L ${a} ${r}`}return s},st=nt(V),ct=nt(z),Z=[];for(let t=1;t<y;t++){const s=V[t-1],n=z[t-1],e=V[t],a=z[t];if(e==null||a==null||s==null||n==null)continue;const r=s-n,o=e-a;if(r<=0&&o>0){const i=w+t*$,l=F((e+a)/2);Z.push({x:i,y:l,type:"bull",idx:t})}else if(r>=0&&o<0){const i=w+t*$,l=F((e+a)/2);Z.push({x:i,y:l,type:"bear",idx:t})}}return S===0?u.jsx("div",{className:"meta",children:"Loading chart..."}):u.jsxs("div",{onWheel:lt,style:{width:"100%",overflow:"hidden",cursor:rt?"zoom-in":it?"zoom-out":"default"},children:[u.jsxs("svg",{className:"chart-svg",viewBox:`0 0 ${O} ${H}`,preserveAspectRatio:"xMidYMid meet",style:{width:"100%",height:"auto",display:"block"},children:[K.map((t,s)=>{if(![t.open,t.high,t.low,t.close].every(d=>isFinite(Number(d))))return null;const n=et+s*$,e=F(t.high),a=F(t.low),r=F(t.open),o=F(t.close),l=t.close>=t.open?"#0f9d58":"#d93025",c=Math.min(r,o),m=Math.max(1,Math.abs(o-r));return u.jsxs("g",{children:[u.jsx("line",{x1:n,x2:n,y1:e,y2:a,stroke:l,strokeWidth:1}),u.jsx("rect",{x:n-P/2,y:c,width:P,height:m,fill:l})]},t.time)}),ct&&u.jsx("path",{className:"ema200",d:ct,fill:"none",stroke:"#888",strokeWidth:1.2}),st&&u.jsx("path",{className:"ema26",d:st,fill:"none",stroke:"#ff9900",strokeWidth:1.6}),Z.map((t,s)=>u.jsx("circle",{className:"cross-marker "+(t.type==="bull"?"bull":"bear"),cx:t.x,cy:t.y,r:4},s))]}),u.jsxs("div",{className:"chart-legend",children:[u.jsxs("span",{className:"legend-item",children:[u.jsx("span",{className:"swatch ema26"}),`EMA${g}`]}),u.jsxs("span",{className:"legend-item",children:[u.jsx("span",{className:"swatch ema200"}),`EMA${x}`]}),u.jsxs("span",{className:"legend-item",children:[u.jsx("span",{className:"swatch bull"}),"Bull Cross"]}),u.jsxs("span",{className:"legend-item",children:[u.jsx("span",{className:"swatch bear"}),"Bear Cross"]})]})]})}export{pt as default};
