import{r as u,j as l}from"./index-Caledh46.js";function G(y,M){const v=2/(M+1),N=[];let p=null;for(let g=0;g<y.length;g++){const o=y[g];if(o==null){N.push(null);continue}p==null?p=o:p=o*v+p*(1-v),N.push(p)}return N}function ut({interval:y="1m",limit:M=200,onCross:v=null,emaShort:N=26,emaLong:p=200,symbol:g="BTCUSDT"}){const[o,A]=u.useState([]),[Q,C]=u.useState(!0),[L,X]=u.useState([]),[E,tt]=u.useState([]),et=u.useRef(null),st=u.useRef(null);u.useEffect(()=>{let t=!1,s=null;async function n(){C(!0);try{const e=`klines:${String(g).toUpperCase()}:${y}:L${M}`,c=1e3*60*5;try{const a=localStorage.getItem(e);if(a){const h=JSON.parse(a);if(h&&Array.isArray(h.data)&&h.ts&&Date.now()-h.ts<c){A(h.data),C(!1);return}}}catch{}const i=`https://api.binance.com/api/v3/klines?symbol=${encodeURIComponent(g)}&interval=${y}&limit=${M}`,r=(await(await fetch(i)).json()).map(a=>({open:parseFloat(a[1]),high:parseFloat(a[2]),low:parseFloat(a[3]),close:parseFloat(a[4]),closed:!0,time:a[0]}));if(t)return;A(r);try{localStorage.setItem(e,JSON.stringify({ts:Date.now(),data:r}))}catch{}C(!1)}catch(e){console.warn("fetch klines failed",e),A([]),C(!1)}}try{const e=String(g||"BTCUSDT").toLowerCase(),i=`wss://stream.binance.com:9443/stream?streams=${`${e}@kline_${y}/${e}@trade`}`;s=new WebSocket(i),s.onmessage=m=>{try{const f=JSON.parse(m.data),r=f.data||f;if(r&&r.k){const a=r.k,h={open:parseFloat(a.o),high:parseFloat(a.h),low:parseFloat(a.l),close:parseFloat(a.c),time:a.t,closed:!!a.x};A(d=>{if(!d||d.length===0)return[h];if(d[d.length-1].time===h.time){const F=d.slice(0,d.length-1);return F.push(h),F}else{const F=d.concat([h]);return F.length>M&&F.shift(),F}});return}}catch{}},s.onerror=m=>console.warn("combined ws error",m)}catch(e){console.warn("failed to open combined websocket",e)}return n(),()=>{t=!0;try{s&&s.close()}catch{}}},[y,M,g]),u.useEffect(()=>{if(!o||o.length===0)return;const t=o.map(e=>e.close),s=G(t,N),n=G(t,p);X(s),tt(n),et.current=s.length?s[s.length-1]:null,st.current=n.length?n[n.length-1]:null},[o,N,p]);const U=600,[W,it]=u.useState(!0),O=W?266:154,x=2,b=o.length,[S,Y]=u.useState(80),j=10,D=Math.max(j,M),w=Math.min(b,S),T=o.slice(-w),B=L.slice(-w),I=E.slice(-w),nt=u.useCallback(t=>{try{t.preventDefault()}catch{}const s=t.deltaY,n=Math.max(1,Math.round(S*.12));let e=S;if(s<0)e=Math.max(j,S-n);else if(s>0){const c=Math.min(Math.max(j,b||0),D);e=Math.min(c,S+n)}e!==S&&Y(e)},[S,j,D,b]),at=w>j,ot=w<Math.min(b,D);u.useEffect(()=>{b&&Y(W?t=>Math.max(j,Math.round(t*.6)):t=>Math.min(Math.max(j,b||0,D),Math.round(t/.6)))},[W]);const J=u.useRef(new Set);u.useEffect(()=>{if(!v||!L||!E)return;const t=o&&o.length>0?o[o.length-1]:null;if(!t||!t.closed)return;const s=Math.min(L.length,E.length);if(s<2)return;const n=s-1,e=L[n-1],c=E[n-1],i=L[n],m=E[n];if(i==null||m==null||e==null||c==null)return;const f=e-c,r=i-m;let a=null;if(f<=0&&r>0?a="bull":f>=0&&r<0&&(a="bear"),a){const h=o&&o.length>0?o[o.length-1].time:Date.now(),d=`${h}:${a}`;if(!J.current.has(d)){J.current.add(d);try{v({type:a,time:h,price:o[o.length-1].close})}catch{}}}},[L,E,v,o]);const K=T.map(t=>Number(t.high)).filter(t=>isFinite(t)),V=T.map(t=>Number(t.low)).filter(t=>isFinite(t));if(K.length===0||V.length===0)return Q?l.jsx("div",{className:"meta",children:"Loading chart..."}):l.jsxs("div",{className:"meta",children:["No data for ",String(g)]});const lt=Math.max(...K),z=Math.min(...V);let k=(U-x*2)/(w-1||1),R=Math.max(1,k*.6);const Z=x,ct=Math.max(x,Math.ceil(R/2)+1);k=(U-Z-ct)/(w-1||1),R=Math.max(1,k*.6);const $=t=>x+(1-(t-z)/(lt-z||1))*(O-x*2),_=t=>{let s="";for(let n=0;n<t.length;n++){const e=t[n];if(e==null)continue;const c=x+n*k,i=$(e);s+=s===""?`M ${c} ${i}`:` L ${c} ${i}`}return s},H=_(B),q=_(I),P=[];for(let t=1;t<w;t++){const s=B[t-1],n=I[t-1],e=B[t],c=I[t];if(e==null||c==null||s==null||n==null)continue;const i=s-n,m=e-c;if(i<=0&&m>0){const f=x+t*k,r=$((e+c)/2);P.push({x:f,y:r,type:"bull",idx:t})}else if(i>=0&&m<0){const f=x+t*k,r=$((e+c)/2);P.push({x:f,y:r,type:"bear",idx:t})}}return b===0?l.jsx("div",{className:"meta",children:"Loading chart..."}):l.jsxs("div",{onWheel:nt,style:{width:"100%",overflow:"hidden",cursor:at?"zoom-in":ot?"zoom-out":"default"},children:[l.jsxs("svg",{className:"chart-svg",viewBox:`0 0 ${U} ${O}`,preserveAspectRatio:"xMidYMid meet",style:{width:"100%",height:"auto",display:"block"},children:[T.map((t,s)=>{if(![t.open,t.high,t.low,t.close].every(d=>isFinite(Number(d))))return null;const n=Z+s*k,e=$(t.high),c=$(t.low),i=$(t.open),m=$(t.close),r=t.close>=t.open?"#0f9d58":"#d93025",a=Math.min(i,m),h=Math.max(1,Math.abs(m-i));return l.jsxs("g",{children:[l.jsx("line",{x1:n,x2:n,y1:e,y2:c,stroke:r,strokeWidth:1}),l.jsx("rect",{x:n-R/2,y:a,width:R,height:h,fill:r})]},t.time)}),q&&l.jsx("path",{className:"ema200",d:q,fill:"none",stroke:"#888",strokeWidth:1.2}),H&&l.jsx("path",{className:"ema26",d:H,fill:"none",stroke:"#ff9900",strokeWidth:1.6}),P.map((t,s)=>l.jsx("circle",{className:"cross-marker "+(t.type==="bull"?"bull":"bear"),cx:t.x,cy:t.y,r:4},s))]}),l.jsxs("div",{className:"chart-legend",children:[l.jsxs("span",{className:"legend-item",children:[l.jsx("span",{className:"swatch ema26"}),`EMA${N}`]}),l.jsxs("span",{className:"legend-item",children:[l.jsx("span",{className:"swatch ema200"}),`EMA${p}`]}),l.jsxs("span",{className:"legend-item",children:[l.jsx("span",{className:"swatch bull"}),"Bull Cross"]}),l.jsxs("span",{className:"legend-item",children:[l.jsx("span",{className:"swatch bear"}),"Bear Cross"]})]})]})}export{ut as default};
