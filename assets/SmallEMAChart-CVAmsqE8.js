import{r as h,j as a}from"./index-B7CFXyxE.js";function V(k,M){const S=2/(M+1),b=[];let p=null;for(let g=0;g<k.length;g++){const x=k[g];if(x==null){b.push(null);continue}p==null?p=x:p=x*S+p*(1-S),b.push(p)}return b}function lt({interval:k="1m",limit:M=200,livePrice:S=null,onTrade:b=null,onCross:p=null,emaShort:g=26,emaLong:x=200,symbol:E="BTCUSDT"}){const[f,L]=h.useState([]),[X,U]=h.useState(!0),[Z,T]=h.useState([]),[tt,v]=h.useState([]),D=h.useRef(null),C=h.useRef(null);h.useEffect(()=>{let t=!1,e=null;async function s(){U(!0);try{const n=`https://api.binance.com/api/v3/klines?symbol=${encodeURIComponent(E)}&interval=${k}&limit=${M}`,c=(await(await fetch(n)).json()).map(l=>({open:parseFloat(l[1]),high:parseFloat(l[2]),low:parseFloat(l[3]),close:parseFloat(l[4]),time:l[0]}));if(t)return;L(c),U(!1)}catch(n){console.warn("fetch klines failed",n),L([]),U(!1)}}try{const n=String(E||"BTCUSDT").toLowerCase(),i=`wss://stream.binance.com:9443/stream?streams=${`${n}@kline_${k}/${n}@trade`}`;e=new WebSocket(i),e.onmessage=c=>{try{const l=JSON.parse(c.data),r=l.data||l;if(r&&r.k){const u=r.k,m={open:parseFloat(u.o),high:parseFloat(u.h),low:parseFloat(u.l),close:parseFloat(u.c),time:u.t};L(d=>{if(!d||d.length===0)return[m];if(d[d.length-1].time===m.time){const $=d.slice(0,d.length-1);return $.push(m),$}else{const $=d.concat([m]);return $.length>M&&$.shift(),$}});return}if(r&&(r.p||r.price)){const u=parseFloat(r.p||r.price||r.P);if(b&&isFinite(u))try{b(u)}catch{}}}catch{}},e.onerror=c=>console.warn("combined ws error",c)}catch(n){console.warn("failed to open combined websocket",n)}return s(),()=>{t=!0;try{e&&e.close()}catch{}}},[k,M,E,b]),h.useEffect(()=>{if(!f||f.length===0)return;const t=f.map(n=>n.close),e=V(t,g),s=V(t,x);T(e),v(s),D.current=e.length?e[e.length-1]:null,C.current=s.length?s[s.length-1]:null},[f,g,x]);const B=h.useRef(null),F=h.useRef(null);h.useEffect(()=>{if(S==null)return;const t=Number(S);if(isFinite(t))return B.current=t,F.current==null&&(F.current=requestAnimationFrame(()=>{const e=B.current;B.current=null,F.current=null,L(s=>{if(!s||s.length===0)return s;const n=s.slice(),o=n[n.length-1];if(!o)return s;const i={...o,close:e,high:Math.max(o.high,e),low:Math.min(o.low,e)};return n[n.length-1]=i,n});try{if(D.current!=null&&C.current!=null){const s=2/(g+1),n=2/(x+1),o=e*s+D.current*(1-s),i=e*n+C.current*(1-n);D.current=o,C.current=i,T(c=>{if(!c||c.length===0)return c;const l=c.slice();return l[l.length-1]=o,l}),v(c=>{if(!c||c.length===0)return c;const l=c.slice();return l[l.length-1]=i,l})}}catch{}})),()=>{F.current&&(cancelAnimationFrame(F.current),F.current=null)}},[S]);const I=600,P=160,N=2,q=f.length,R=Math.min(q,120),W=f.slice(-R),w=Z.slice(-R),y=tt.slice(-R),H=W.map(t=>Number(t.high)).filter(t=>isFinite(t)),J=W.map(t=>Number(t.low)).filter(t=>isFinite(t));if(H.length===0||J.length===0)return X?a.jsx("div",{className:"meta",children:"Loading chart..."}):a.jsxs("div",{className:"meta",children:["No data for ",String(E)]});const et=Math.max(...H),K=Math.min(...J),A=(I-N*2)/(R-1||1),O=Math.max(1,A*.6),j=t=>N+(1-(t-K)/(et-K||1))*(P-N*2),_=t=>{let e="";for(let s=0;s<t.length;s++){const n=t[s];if(n==null)continue;const o=N+s*A,i=j(n);e+=e===""?`M ${o} ${i}`:` L ${o} ${i}`}return e},z=_(w),G=_(y),Y=[];for(let t=1;t<R;t++){const e=w[t-1],s=y[t-1],n=w[t],o=y[t];if(n==null||o==null||e==null||s==null)continue;const i=e-s,c=n-o;if(i<=0&&c>0){const l=N+t*A,r=j((n+o)/2);Y.push({x:l,y:r,type:"bull",idx:t})}else if(i>=0&&c<0){const l=N+t*A,r=j((n+o)/2);Y.push({x:l,y:r,type:"bear",idx:t})}}const Q=h.useRef(new Set);return h.useEffect(()=>{if(!p||!w||!y)return;const t=Math.min(w.length,y.length);if(t<2)return;const e=t-1,s=w[e-1],n=y[e-1],o=w[e],i=y[e];if(o==null||i==null||s==null||n==null)return;const c=s-n,l=o-i;let r=null;if(c<=0&&l>0?r="bull":c>=0&&l<0&&(r="bear"),r){const u=f&&f.length>0?f[f.length-1].time:Date.now(),m=`${u}:${r}`;if(!Q.current.has(m)){Q.current.add(m);try{p({type:r,time:u,price:f[f.length-1].close})}catch{}}}},[w,y]),q===0?a.jsx("div",{className:"meta",children:"Loading chart..."}):a.jsxs("div",{style:{width:"100%",overflow:"hidden"},children:[a.jsxs("svg",{className:"chart-svg",viewBox:`0 0 ${I} ${P}`,preserveAspectRatio:"none",style:{width:"100%",height:P},children:[W.map((t,e)=>{if(![t.open,t.high,t.low,t.close].every(d=>isFinite(Number(d))))return null;const s=N+e*A,n=j(t.high),o=j(t.low),i=j(t.open),c=j(t.close),r=t.close>=t.open?"#0f9d58":"#d93025",u=Math.min(i,c),m=Math.max(1,Math.abs(c-i));return a.jsxs("g",{children:[a.jsx("line",{x1:s,x2:s,y1:n,y2:o,stroke:r,strokeWidth:1}),a.jsx("rect",{x:s-O/2,y:u,width:O,height:m,fill:r})]},t.time)}),G&&a.jsx("path",{className:"ema200",d:G,fill:"none",stroke:"#888",strokeWidth:1.2}),z&&a.jsx("path",{className:"ema26",d:z,fill:"none",stroke:"#ff9900",strokeWidth:1.6}),Y.map((t,e)=>a.jsx("circle",{className:"cross-marker "+(t.type==="bull"?"bull":"bear"),cx:t.x,cy:t.y,r:4},e))]}),a.jsxs("div",{className:"chart-legend",children:[a.jsxs("span",{className:"legend-item",children:[a.jsx("span",{className:"swatch ema26"}),`EMA${g}`]}),a.jsxs("span",{className:"legend-item",children:[a.jsx("span",{className:"swatch ema200"}),`EMA${x}`]}),a.jsxs("span",{className:"legend-item",children:[a.jsx("span",{className:"swatch bull"}),"Bull Cross"]}),a.jsxs("span",{className:"legend-item",children:[a.jsx("span",{className:"swatch bear"}),"Bear Cross"]})]})]})}export{lt as default};
