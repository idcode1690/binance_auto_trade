import{r as i,j as o}from"./index-Fm3Tdyo8.js";function Me(p,y){const _=2/(y+1),M=[];let S=null;for(let v=0;v<p.length;v++){const w=p[v];if(w==null){M.push(null);continue}S==null?S=w:S=w*_+S*(1-_),M.push(S)}return M}function Ae({interval:p="1m",limit:y=200,onCross:_=null,onPrice:M=null,emaShort:S=26,emaLong:v=200,symbol:w="BTCUSDT"}){const[m,O]=i.useState([]),[Se,q]=i.useState(!0),[Fe,be]=i.useState([]),[je,Ne]=i.useState([]),Re=i.useRef(null),ke=i.useRef(null),z=i.useRef(null),V=i.useRef(null),G=i.useRef(!1);i.useRef(null),i.useRef(0);const X=i.useRef([]),J=i.useRef(!0),ae=i.useRef(null),Y=e=>({"1m":6e4,"3m":18e4,"5m":3e5,"15m":9e5,"30m":18e5,"1h":36e5,"2h":72e5,"4h":144e5,"6h":216e5,"8h":288e5,"12h":432e5,"1d":864e5,"3d":2592e5,"1w":6048e5,"1M":2592e6})[e]||6e4;i.useEffect(()=>{let e=!1,s=null,t=null,n=null,c=null;function f(){try{const g=`wss://stream.binance.com:9443/ws/${String(w||"BTCUSDT").toLowerCase()}@trade`;t=new WebSocket(g),V.current=t,t.onmessage=a=>{try{const k=JSON.parse(a.data),r=parseFloat(k.p);if(!isFinite(r))return;if(O(h=>{if(!h||h.length===0)return h;const T=h.slice(),j=T[T.length-1];return j&&j.closed===!1?(T[T.length-1]={...j,close:r},T):h}),M)try{M(r)}catch{}}catch{}},t.onclose=()=>{e||(c=setTimeout(()=>f(),3e3))},t.onerror=()=>{}}catch{}}async function D(){q(!0),J.current=!0;try{const u=`https://api.binance.com/api/v3/klines?symbol=${encodeURIComponent(w)}&interval=${p}&limit=${y}`,a=await(await fetch(u)).json();let r=(Array.isArray(a)?a:[]).map(l=>{const d=Number(l[0]),U=parseFloat(l[1]),N=parseFloat(l[2]),x=parseFloat(l[3]),Z=parseFloat(l[4]),B=Number(l[6]);return{time:d,open:isFinite(U)?U:null,high:isFinite(N)?N:null,low:isFinite(x)?x:null,close:isFinite(Z)?Z:null,closed:isFinite(B)?B<=Date.now():!0,closeTime:isFinite(B)?B:null}});r.sort((l,d)=>l.time-d.time);const h=[];for(let l=1;l<r.length;l++){const d=r[l-1],U=r[l];if(!isFinite(d.time)||!isFinite(U.time))continue;const N=U.time-d.time;if(N>Y(p)+1e3){const x=Math.max(1,Math.round(N/Y(p))-1);h.push({start:d.time+Y(p),end:U.time-Y(p),missingCount:x})}}if(h.length>0){for(const l of h)try{const d=`https://api.binance.com/api/v3/klines?symbol=${encodeURIComponent(w)}&interval=${p}&startTime=${l.start}&endTime=${l.end}&limit=${l.missingCount}`,N=await(await fetch(d)).json();if(Array.isArray(N)&&N.length)for(const x of N){const Z=Number(x[0]),B=parseFloat(x[1]),xe=parseFloat(x[2]),we=parseFloat(x[3]),ye=parseFloat(x[4]),Q=Number(x[6]);r.push({time:Z,open:isFinite(B)?B:null,high:isFinite(xe)?xe:null,low:isFinite(we)?we:null,close:isFinite(ye)?ye:null,closed:isFinite(Q)?Q<=Date.now():!0,closeTime:isFinite(Q)?Q:null})}}catch{}r.sort((l,d)=>l.time-d.time)}const T=new Map;for(const l of r)T.set(l.time,l);let j=Array.from(T.values()).sort((l,d)=>l.time-d.time);j.length>y&&(j=j.slice(j.length-y)),O(j),q(!1),J.current=!1}catch{O([]),q(!1),J.current=!1}}function I(u){O(g=>{let a=g&&g.length?g.slice():[];if(!g||g.length===0)a=[u];else{const k=a[a.length-1];if(u.time===k.time)a[a.length-1]=u;else if(u.time>k.time)a.push(u),a.length>y&&(a=a.slice(a.length-y));else{const r=a.findIndex(h=>h.time===u.time);r>=0&&(a[r]=u)}}return a})}function b(){if(!G.current){G.current=!0;try{const g=`wss://stream.binance.com:9443/ws/${String(w||"BTCUSDT").toLowerCase()}@kline_${p}`;s=new WebSocket(g),z.current=s,s.onopen=()=>{},s.onclose=()=>{e||(n=setTimeout(()=>b(),3e3))},s.onerror=()=>{},s.onmessage=a=>{try{const r=JSON.parse(a.data).k;if(r){const h={open:parseFloat(r.o),high:parseFloat(r.h),low:parseFloat(r.l),close:parseFloat(r.c),time:r.t,closed:!!r.x};if(J.current){X.current=X.current||[],X.current.push(h);return}I(h)}}catch{}}}catch{}}}return D().then(()=>{b(),f()}),()=>{e=!0,n&&clearTimeout(n),c&&clearTimeout(c);try{z.current&&z.current.readyState!==WebSocket.CLOSED&&z.current.close()}catch{}try{V.current&&V.current.readyState!==WebSocket.CLOSED&&V.current.close()}catch{}G.current=!1}},[p,y,w]),i.useEffect(()=>{if(!m||m.length===0)return;const e=m.map(n=>n.close),s=Me(e,S),t=Me(e,v);if(be(s),Ne(t),Re.current=s.length?s[s.length-1]:null,ke.current=t.length?t[t.length-1]:null,M&&m.length>0){const n=m[m.length-1];if(n&&typeof n.close=="number"&&isFinite(n.close))try{M(n.close)}catch{}}},[m,S,v,M]);const P=600,[ee,$e]=i.useState(!0),re=ee?266:154,R=2,L=m.length,[C,te]=i.useState(80),$=10,H=Math.max($,y),[ce,se]=i.useState(null);i.useEffect(()=>{if(!m||m.length===0)return se(null);const e=m[m.length-1];if(!e||!e.time)return se(null);const s=Y(p);let t=e.time+s;e.closed&&(t=Date.now()+s);function n(){const f=t-Date.now();se(f>0?f/1e3:0)}n();const c=setInterval(n,300);return()=>clearInterval(c)},[m,p]);const F=Math.min(L,C),E=m.slice(-F),ne=Fe.slice(-F),oe=je.slice(-F),le=i.useCallback(e=>{try{e.preventDefault()}catch{}const s=e.deltaY,t=Math.max(1,Math.round(C*.12));let n=C;if(s<0)n=Math.max($,C-t);else if(s>0){const c=Math.min(Math.max($,L||0),H);n=Math.min(c,C+t)}n!==C&&te(n)},[C,$,H,L]),Te=F>$,ve=F<Math.min(L,H);i.useEffect(()=>{L&&te(ee?e=>Math.max($,Math.round(e*.6)):e=>Math.min(Math.max($,L||0,H),Math.round(e/.6)))},[ee]),i.useEffect(()=>{const e=ae.current;if(e)return e.addEventListener("wheel",le,{passive:!1}),()=>{e.removeEventListener("wheel",le,{passive:!1})}},[le]);const ue=E.map(e=>{const s=[e.high,e.open,e.close,e.low].map(t=>Number(t)).filter(t=>isFinite(t));return s.length?Math.max(...s):null}).filter(e=>e!=null),he=E.map(e=>{const s=[e.low,e.open,e.close,e.high].map(t=>Number(t)).filter(t=>isFinite(t));return s.length?Math.min(...s):null}).filter(e=>e!=null);if(ue.length===0||he.length===0)return Se?o.jsx("div",{className:"meta",children:"Loading chart..."}):o.jsxs("div",{className:"meta",children:[o.jsxs("div",{children:["No data for ",String(w)]}),o.jsxs("details",{style:{maxHeight:200,overflow:"auto"},children:[o.jsx("summary",{children:"Raw slice (first 20)"}),o.jsx("pre",{style:{whiteSpace:"pre-wrap",fontSize:12},children:JSON.stringify(E.slice(-20),null,2)})]})]});const Le=Math.max(...ue),me=Math.min(...he);let A=(P-R*2)/(F-1||1),K=Math.max(1,A*.6);const fe=R,Ce=Math.max(R,Math.ceil(K/2)+1);A=(P-fe-Ce)/(F-1||1),K=Math.max(1,A*.6);const W=e=>R+(1-(e-me)/(Le-me||1))*(re-R*2),de=e=>{let s="";for(let t=0;t<e.length;t++){const n=e[t];if(n==null)continue;const c=R+t*A,f=W(n);s+=s===""?`M ${c} ${f}`:` L ${c} ${f}`}return s},pe=de(ne),ge=de(oe),ie=[];for(let e=1;e<F&&!(e===F-1&&E.length&&!E[E.length-1].closed);e++){const s=ne[e-1],t=oe[e-1],n=ne[e],c=oe[e];if(n==null||c==null||s==null||t==null)continue;const f=s-t,D=n-c;if(f<=0&&D>0){const I=R+e*A,b=W((n+c)/2);ie.push({x:I,y:b,type:"bull",idx:e})}else if(f>=0&&D<0){const I=R+e*A,b=W((n+c)/2);ie.push({x:I,y:b,type:"bear",idx:e})}}return L===0?o.jsx("div",{className:"meta",children:"Loading chart..."}):o.jsxs("div",{ref:ae,style:{width:"100%",overflow:"hidden",cursor:Te?"zoom-in":ve?"zoom-out":"default"},children:[o.jsx("div",{style:{fontSize:14,fontWeight:600,color:"#888",marginBottom:4,textAlign:"right"},children:ce!==null&&o.jsxs("span",{children:["Until candle close ",ce.toFixed(1),"s"]})}),o.jsxs("svg",{className:"chart-svg",viewBox:`0 0 ${P} ${re}`,preserveAspectRatio:"xMidYMid meet",style:{width:"100%",height:"auto",display:"block"},children:[E.map((e,s)=>{if(![e.open,e.high,e.low,e.close].every(a=>isFinite(Number(a))))return null;const t=fe+s*A,n=W(e.high),c=W(e.low),f=W(e.open),D=W(e.close),b=e.close>=e.open?"#0f9d58":"#d93025",u=Math.min(f,D),g=Math.max(1,Math.abs(D-f));return o.jsxs("g",{children:[o.jsx("line",{x1:t,x2:t,y1:n,y2:c,stroke:b,strokeWidth:1}),o.jsx("rect",{x:t-K/2,y:u,width:K,height:g,fill:b})]},e.time)}),ge&&o.jsx("path",{className:"ema200",d:ge,fill:"none",stroke:"#888",strokeWidth:1.2}),pe&&o.jsx("path",{className:"ema26",d:pe,fill:"none",stroke:"#ff9900",strokeWidth:1.6}),ie.map((e,s)=>o.jsx("circle",{className:"cross-marker "+(e.type==="bull"?"bull":"bear"),cx:e.x,cy:e.y,r:4},s))]}),o.jsxs("div",{className:"chart-legend",children:[o.jsxs("span",{className:"legend-item",children:[o.jsx("span",{className:"swatch ema26"}),`EMA${S}`]}),o.jsxs("span",{className:"legend-item",children:[o.jsx("span",{className:"swatch ema200"}),`EMA${v}`]}),o.jsxs("span",{className:"legend-item",children:[o.jsx("span",{className:"swatch bull"}),"Bull Cross"]}),o.jsxs("span",{className:"legend-item",children:[o.jsx("span",{className:"swatch bear"}),"Bear Cross"]})]})]})}export{Ae as default};
