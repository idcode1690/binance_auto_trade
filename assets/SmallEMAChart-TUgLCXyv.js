import{r as f,j as i}from"./index-yo-zwGuh.js";function O(b,F){const j=2/(F+1),k=[];let p=null;for(let u=0;u<b.length;u++){const x=b[u];if(x==null){k.push(null);continue}p==null?p=x:p=x*j+p*(1-j),k.push(p)}return k}function Z({interval:b="1m",limit:F=200,livePrice:j=null,onTrade:k=null,onCross:p=null}){const[u,x]=f.useState([]),[_,Y]=f.useState([]),[z,B]=f.useState([]),$=f.useRef(null),S=f.useRef(null);f.useEffect(()=>{let t=!1,e=null;async function n(){try{const c=`https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=${b}&limit=${F}`,l=(await(await fetch(c)).json()).map(s=>({open:parseFloat(s[1]),high:parseFloat(s[2]),low:parseFloat(s[3]),close:parseFloat(s[4]),time:s[0]}));if(t)return;x(l)}catch(c){console.warn("fetch klines failed",c)}}try{const o=`wss://stream.binance.com:9443/stream?streams=${`btcusdt@kline_${b}/btcusdt@trade`}`;e=new WebSocket(o),e.onmessage=a=>{try{const l=JSON.parse(a.data),s=l.data||l;if(s&&s.k){const r=s.k,m={open:parseFloat(r.o),high:parseFloat(r.h),low:parseFloat(r.l),close:parseFloat(r.c),time:r.t};x(h=>{if(!h||h.length===0)return[m];if(h[h.length-1].time===m.time){const M=h.slice(0,h.length-1);return M.push(m),M}else{const M=h.concat([m]);return M.length>F&&M.shift(),M}});return}if(s&&(s.p||s.price)){const r=parseFloat(s.p||s.price||s.P);if(k&&isFinite(r))try{k(r)}catch{}}}catch{}},e.onerror=a=>console.warn("combined ws error",a)}catch(c){console.warn("failed to open combined websocket",c)}return n(),()=>{t=!0;try{e&&e.close()}catch{}}},[b,F]),f.useEffect(()=>{if(!u||u.length===0)return;const t=u.map(c=>c.close),e=O(t,26),n=O(t,200);Y(e),B(n),$.current=e.length?e[e.length-1]:null,S.current=n.length?n[n.length-1]:null},[u]);const A=f.useRef(null),N=f.useRef(null);f.useEffect(()=>{if(j==null)return;const t=Number(j);if(isFinite(t))return A.current=t,N.current==null&&(N.current=requestAnimationFrame(()=>{const e=A.current;A.current=null,N.current=null,x(n=>{if(!n||n.length===0)return n;const c=n.slice(),o=c[c.length-1];if(!o)return n;const a={...o,close:e,high:Math.max(o.high,e),low:Math.min(o.low,e)};return c[c.length-1]=a,c});try{if($.current!=null&&S.current!=null){const n=.07407407407407407,c=2/201,o=e*n+$.current*(1-n),a=e*c+S.current*(1-c);$.current=o,S.current=a,Y(l=>{if(!l||l.length===0)return l;const s=l.slice();return s[s.length-1]=o,s}),B(l=>{if(!l||l.length===0)return l;const s=l.slice();return s[s.length-1]=a,s})}}catch{}})),()=>{N.current&&(cancelAnimationFrame(N.current),N.current=null)}},[j]);const U=f.useRef(new Set);f.useEffect(()=>{if(!p||!d||!g)return;const t=Math.min(d.length,g.length);if(t<2)return;const e=t-1,n=d[e-1],c=g[e-1],o=d[e],a=g[e];if(o==null||a==null||n==null||c==null)return;const l=n-c,s=o-a;let r=null;if(l<=0&&s>0?r="bull":l>=0&&s<0&&(r="bear"),r){const m=u&&u.length>0?u[u.length-1].time:Date.now(),h=`${m}:${r}`;if(!U.current.has(h)){U.current.add(h);try{p({type:r,time:m,price:u[u.length-1].close})}catch{}}}},[d,g]);const C=600,D=160,w=2,L=u.length;if(L===0)return i.jsx("div",{className:"meta",children:"Loading chart..."});const E=Math.min(L,120),P=u.slice(-E),d=_.slice(-E),g=z.slice(-E),G=P.map(t=>t.high),I=P.map(t=>t.low),Q=Math.max(...G),T=Math.min(...I),R=(C-w*2)/(E-1||1),q=Math.max(1,R*.6),y=t=>w+(1-(t-T)/(Q-T||1))*(D-w*2),H=t=>{let e="";for(let n=0;n<t.length;n++){const c=t[n];if(c==null)continue;const o=w+n*R,a=y(c);e+=e===""?`M ${o} ${a}`:` L ${o} ${a}`}return e},J=H(d),K=H(g),W=[];for(let t=1;t<E;t++){const e=d[t-1],n=g[t-1],c=d[t],o=g[t];if(c==null||o==null||e==null||n==null)continue;const a=e-n,l=c-o;if(a<=0&&l>0){const s=w+t*R,r=y((c+o)/2);W.push({x:s,y:r,type:"bull",idx:t})}else if(a>=0&&l<0){const s=w+t*R,r=y((c+o)/2);W.push({x:s,y:r,type:"bear",idx:t})}}return i.jsxs("div",{style:{width:"100%",overflow:"hidden"},children:[i.jsxs("svg",{className:"chart-svg",viewBox:`0 0 ${C} ${D}`,preserveAspectRatio:"none",style:{width:"100%",height:D},children:[P.map((t,e)=>{const n=w+e*R,c=y(t.high),o=y(t.low),a=y(t.open),l=y(t.close),r=t.close>=t.open?"#0f9d58":"#d93025",m=Math.min(a,l),h=Math.max(1,Math.abs(l-a));return i.jsxs("g",{children:[i.jsx("line",{x1:n,x2:n,y1:c,y2:o,stroke:r,strokeWidth:1}),i.jsx("rect",{x:n-q/2,y:m,width:q,height:h,fill:r})]},t.time)}),K&&i.jsx("path",{className:"ema200",d:K,fill:"none",stroke:"#888",strokeWidth:1.2}),J&&i.jsx("path",{className:"ema26",d:J,fill:"none",stroke:"#ff9900",strokeWidth:1.6}),W.map((t,e)=>i.jsx("circle",{className:"cross-marker "+(t.type==="bull"?"bull":"bear"),cx:t.x,cy:t.y,r:4},e))]}),i.jsxs("div",{className:"chart-legend",children:[i.jsxs("span",{className:"legend-item",children:[i.jsx("span",{className:"swatch ema26"}),"EMA26"]}),i.jsxs("span",{className:"legend-item",children:[i.jsx("span",{className:"swatch ema200"}),"EMA200"]}),i.jsxs("span",{className:"legend-item",children:[i.jsx("span",{className:"swatch bull"}),"Bull Cross"]}),i.jsxs("span",{className:"legend-item",children:[i.jsx("span",{className:"swatch bear"}),"Bear Cross"]})]})]})}export{Z as default};
