import{r as f,j as a}from"./index-CXM4TAzn.js";function ot(S,F){const $=2/(F+1),N=[];let g=null;for(let x=0;x<S.length;x++){const w=S[x];if(w==null){N.push(null);continue}g==null?g=w:g=w*$+g*(1-$),N.push(g)}return N}function dt({interval:S="1m",limit:F=200,livePrice:$=null,onTrade:N=null,onCross:g=null,emaShort:x=26,emaLong:w=200,symbol:D="BTCUSDT"}){const[r,W]=f.useState([]),[lt,P]=f.useState(!0),[R,q]=f.useState([]),[A,H]=f.useState([]),U=f.useRef(null),Y=f.useRef(null);f.useEffect(()=>{let t=!1,s=null;async function n(){P(!0);try{const e=`https://api.binance.com/api/v3/klines?symbol=${encodeURIComponent(D)}&interval=${S}&limit=${F}`,l=(await(await fetch(e)).json()).map(o=>({open:parseFloat(o[1]),high:parseFloat(o[2]),low:parseFloat(o[3]),close:parseFloat(o[4]),closed:!0,time:o[0]}));if(t)return;W(l),P(!1)}catch(e){console.warn("fetch klines failed",e),W([]),P(!1)}}try{const e=String(D||"BTCUSDT").toLowerCase(),i=`wss://stream.binance.com:9443/stream?streams=${`${e}@kline_${S}/${e}@trade`}`;s=new WebSocket(i),s.onmessage=l=>{try{const o=JSON.parse(l.data),u=o.data||o;if(u&&u.k){const h=u.k,p={open:parseFloat(h.o),high:parseFloat(h.h),low:parseFloat(h.l),close:parseFloat(h.c),time:h.t,closed:!!h.x};W(m=>{if(!m||m.length===0)return[p];if(m[m.length-1].time===p.time){const L=m.slice(0,m.length-1);return L.push(p),L}else{const L=m.concat([p]);return L.length>F&&L.shift(),L}});return}if(u&&(u.p||u.price)){const h=parseFloat(u.p||u.price||u.P);if(N&&isFinite(h))try{N(h)}catch{}}}catch{}},s.onerror=l=>console.warn("combined ws error",l)}catch(e){console.warn("failed to open combined websocket",e)}return n(),()=>{t=!0;try{s&&s.close()}catch{}}},[S,F,D,N]),f.useEffect(()=>{if(!r||r.length===0)return;const t=r.map(e=>e.close),s=ot(t,x),n=ot(t,w);q(s),H(n),U.current=s.length?s[s.length-1]:null,Y.current=n.length?n[n.length-1]:null},[r,x,w]);const v=f.useRef(null),E=f.useRef(null);f.useEffect(()=>{if($==null)return;const t=Number($);if(isFinite(t))return v.current=t,E.current==null&&(E.current=requestAnimationFrame(()=>{const s=v.current;v.current=null,E.current=null,W(n=>{if(!n||n.length===0)return n;const e=n.slice(),c=e[e.length-1];if(!c)return n;const i={...c,close:s,high:Math.max(c.high,s),low:Math.min(c.low,s)};return e[e.length-1]=i,e});try{if(U.current!=null&&Y.current!=null){const n=2/(x+1),e=2/(w+1),c=s*n+U.current*(1-n),i=s*e+Y.current*(1-e);U.current=c,Y.current=i,q(l=>{if(!l||l.length===0)return l;const o=l.slice();return o[o.length-1]=c,o}),H(l=>{if(!l||l.length===0)return l;const o=l.slice();return o[o.length-1]=i,o})}}catch{}})),()=>{E.current&&(cancelAnimationFrame(E.current),E.current=null)}},[$]);const I=600,T=160,y=2,C=r.length,[d,J]=f.useState(120),M=10,V=Math.max(M,F),_=f.useRef(!1);f.useEffect(()=>{const t=r.length;if(_.current||!t||t<=0)return;const s=Math.min(d,Math.max(M,t)),e=Math.max(1,Math.round(s*.12))*10,c=Math.max(M,s-e);c!==d&&J(c),_.current=!0},[r,d,M]);const b=Math.min(C,d),Z=r.slice(-b),z=R.slice(-b),K=A.slice(-b),at=f.useCallback(t=>{try{t.preventDefault()}catch{}const s=t.deltaY,n=Math.max(1,Math.round(d*.12));let e=d;if(s<0)e=Math.max(M,d-n);else if(s>0){const c=Math.min(Math.max(M,C||0),V);e=Math.min(c,d+n)}e!==d&&J(e)},[d,M,V,C]),rt=b>M,it=b<Math.min(C,V),G=f.useRef(new Set);f.useEffect(()=>{if(!g||!R||!A)return;const t=r&&r.length>0?r[r.length-1]:null;if(!t||!t.closed)return;const s=Math.min(R.length,A.length);if(s<2)return;const n=s-1,e=R[n-1],c=A[n-1],i=R[n],l=A[n];if(i==null||l==null||e==null||c==null)return;const o=e-c,u=i-l;let h=null;if(o<=0&&u>0?h="bull":o>=0&&u<0&&(h="bear"),h){const p=r&&r.length>0?r[r.length-1].time:Date.now(),m=`${p}:${h}`;if(!G.current.has(m)){G.current.add(m);try{g({type:h,time:p,price:r[r.length-1].close})}catch{}}}},[R,A,g,r]);const Q=Z.map(t=>Number(t.high)).filter(t=>isFinite(t)),X=Z.map(t=>Number(t.low)).filter(t=>isFinite(t));if(Q.length===0||X.length===0)return lt?a.jsx("div",{className:"meta",children:"Loading chart..."}):a.jsxs("div",{className:"meta",children:["No data for ",String(D)]});const ut=Math.max(...Q),tt=Math.min(...X);let j=(I-y*2)/(b-1||1),B=Math.max(1,j*.6);const et=y,ht=Math.max(y,Math.ceil(B/2)+1);j=(I-et-ht)/(b-1||1),B=Math.max(1,j*.6);const k=t=>y+(1-(t-tt)/(ut-tt||1))*(T-y*2),nt=t=>{let s="";for(let n=0;n<t.length;n++){const e=t[n];if(e==null)continue;const c=y+n*j,i=k(e);s+=s===""?`M ${c} ${i}`:` L ${c} ${i}`}return s},st=nt(z),ct=nt(K),O=[];for(let t=1;t<b;t++){const s=z[t-1],n=K[t-1],e=z[t],c=K[t];if(e==null||c==null||s==null||n==null)continue;const i=s-n,l=e-c;if(i<=0&&l>0){const o=y+t*j,u=k((e+c)/2);O.push({x:o,y:u,type:"bull",idx:t})}else if(i>=0&&l<0){const o=y+t*j,u=k((e+c)/2);O.push({x:o,y:u,type:"bear",idx:t})}}return C===0?a.jsx("div",{className:"meta",children:"Loading chart..."}):a.jsxs("div",{onWheel:at,style:{width:"100%",overflow:"hidden",cursor:rt?"zoom-in":it?"zoom-out":"default"},children:[a.jsxs("svg",{className:"chart-svg",viewBox:`0 0 ${I} ${T}`,preserveAspectRatio:"none",style:{width:"100%",height:T},children:[Z.map((t,s)=>{if(![t.open,t.high,t.low,t.close].every(m=>isFinite(Number(m))))return null;const n=et+s*j,e=k(t.high),c=k(t.low),i=k(t.open),l=k(t.close),u=t.close>=t.open?"#0f9d58":"#d93025",h=Math.min(i,l),p=Math.max(1,Math.abs(l-i));return a.jsxs("g",{children:[a.jsx("line",{x1:n,x2:n,y1:e,y2:c,stroke:u,strokeWidth:1}),a.jsx("rect",{x:n-B/2,y:h,width:B,height:p,fill:u})]},t.time)}),ct&&a.jsx("path",{className:"ema200",d:ct,fill:"none",stroke:"#888",strokeWidth:1.2}),st&&a.jsx("path",{className:"ema26",d:st,fill:"none",stroke:"#ff9900",strokeWidth:1.6}),O.map((t,s)=>a.jsx("circle",{className:"cross-marker "+(t.type==="bull"?"bull":"bear"),cx:t.x,cy:t.y,r:4},s))]}),a.jsxs("div",{className:"chart-legend",children:[a.jsxs("span",{className:"legend-item",children:[a.jsx("span",{className:"swatch ema26"}),`EMA${x}`]}),a.jsxs("span",{className:"legend-item",children:[a.jsx("span",{className:"swatch ema200"}),`EMA${w}`]}),a.jsxs("span",{className:"legend-item",children:[a.jsx("span",{className:"swatch bull"}),"Bull Cross"]}),a.jsxs("span",{className:"legend-item",children:[a.jsx("span",{className:"swatch bear"}),"Bear Cross"]})]})]})}export{dt as default};
