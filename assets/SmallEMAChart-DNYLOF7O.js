import{r as f,j as i}from"./index-CSgfl-Ho.js";function G(N,F){const $=2/(F+1),b=[];let p=null;for(let d=0;d<N.length;d++){const g=N[d];if(g==null){b.push(null);continue}p==null?p=g:p=g*$+p*(1-$),b.push(p)}return b}function nt({interval:N="1m",limit:F=200,livePrice:$=null,onTrade:b=null,onCross:p=null,emaShort:d=26,emaLong:g=200,symbol:D="BTCUSDT"}){const[h,C]=f.useState([]),[Q,Y]=f.useState([]),[V,T]=f.useState([]),E=f.useRef(null),L=f.useRef(null);f.useEffect(()=>{let t=!1,e=null;async function s(){try{const n=`https://api.binance.com/api/v3/klines?symbol=${encodeURIComponent(D)}&interval=${N}&limit=${F}`,l=(await(await fetch(n)).json()).map(c=>({open:parseFloat(c[1]),high:parseFloat(c[2]),low:parseFloat(c[3]),close:parseFloat(c[4]),time:c[0]}));if(t)return;C(l)}catch(n){console.warn("fetch klines failed",n)}}try{const n=String(D||"BTCUSDT").toLowerCase(),a=`wss://stream.binance.com:9443/stream?streams=${`${n}@kline_${N}/${n}@trade`}`;e=new WebSocket(a),e.onmessage=l=>{try{const c=JSON.parse(l.data),r=c.data||c;if(r&&r.k){const u=r.k,m={open:parseFloat(u.o),high:parseFloat(u.h),low:parseFloat(u.l),close:parseFloat(u.c),time:u.t};C(y=>{if(!y||y.length===0)return[m];if(y[y.length-1].time===m.time){const M=y.slice(0,y.length-1);return M.push(m),M}else{const M=y.concat([m]);return M.length>F&&M.shift(),M}});return}if(r&&(r.p||r.price)){const u=parseFloat(r.p||r.price||r.P);if(b&&isFinite(u))try{b(u)}catch{}}}catch{}},e.onerror=l=>console.warn("combined ws error",l)}catch(n){console.warn("failed to open combined websocket",n)}return s(),()=>{t=!0;try{e&&e.close()}catch{}}},[N,F,D,b]),f.useEffect(()=>{if(!h||h.length===0)return;const t=h.map(n=>n.close),e=G(t,d),s=G(t,g);Y(e),T(s),E.current=e.length?e[e.length-1]:null,L.current=s.length?s[s.length-1]:null},[h,d,g]);const U=f.useRef(null),S=f.useRef(null);f.useEffect(()=>{if($==null)return;const t=Number($);if(isFinite(t))return U.current=t,S.current==null&&(S.current=requestAnimationFrame(()=>{const e=U.current;U.current=null,S.current=null,C(s=>{if(!s||s.length===0)return s;const n=s.slice(),o=n[n.length-1];if(!o)return s;const a={...o,close:e,high:Math.max(o.high,e),low:Math.min(o.low,e)};return n[n.length-1]=a,n});try{if(E.current!=null&&L.current!=null){const s=2/(d+1),n=2/(g+1),o=e*s+E.current*(1-s),a=e*n+L.current*(1-n);E.current=o,L.current=a,Y(l=>{if(!l||l.length===0)return l;const c=l.slice();return c[c.length-1]=o,c}),T(l=>{if(!l||l.length===0)return l;const c=l.slice();return c[c.length-1]=a,c})}}catch{}})),()=>{S.current&&(cancelAnimationFrame(S.current),S.current=null)}},[$]);const q=600,B=160,j=2,H=h.length,R=Math.min(H,120),P=h.slice(-R),x=Q.slice(-R),w=V.slice(-R),X=P.map(t=>t.high),Z=P.map(t=>t.low),v=Math.max(...X),I=Math.min(...Z),A=(q-j*2)/(R-1||1),J=Math.max(1,A*.6),k=t=>j+(1-(t-I)/(v-I||1))*(B-j*2),K=t=>{let e="";for(let s=0;s<t.length;s++){const n=t[s];if(n==null)continue;const o=j+s*A,a=k(n);e+=e===""?`M ${o} ${a}`:` L ${o} ${a}`}return e},O=K(x),_=K(w),W=[];for(let t=1;t<R;t++){const e=x[t-1],s=w[t-1],n=x[t],o=w[t];if(n==null||o==null||e==null||s==null)continue;const a=e-s,l=n-o;if(a<=0&&l>0){const c=j+t*A,r=k((n+o)/2);W.push({x:c,y:r,type:"bull",idx:t})}else if(a>=0&&l<0){const c=j+t*A,r=k((n+o)/2);W.push({x:c,y:r,type:"bear",idx:t})}}const z=f.useRef(new Set);return f.useEffect(()=>{if(!p||!x||!w)return;const t=Math.min(x.length,w.length);if(t<2)return;const e=t-1,s=x[e-1],n=w[e-1],o=x[e],a=w[e];if(o==null||a==null||s==null||n==null)return;const l=s-n,c=o-a;let r=null;if(l<=0&&c>0?r="bull":l>=0&&c<0&&(r="bear"),r){const u=h&&h.length>0?h[h.length-1].time:Date.now(),m=`${u}:${r}`;if(!z.current.has(m)){z.current.add(m);try{p({type:r,time:u,price:h[h.length-1].close})}catch{}}}},[x,w]),H===0?i.jsx("div",{className:"meta",children:"Loading chart..."}):i.jsxs("div",{style:{width:"100%",overflow:"hidden"},children:[i.jsxs("svg",{className:"chart-svg",viewBox:`0 0 ${q} ${B}`,preserveAspectRatio:"none",style:{width:"100%",height:B},children:[P.map((t,e)=>{const s=j+e*A,n=k(t.high),o=k(t.low),a=k(t.open),l=k(t.close),r=t.close>=t.open?"#0f9d58":"#d93025",u=Math.min(a,l),m=Math.max(1,Math.abs(l-a));return i.jsxs("g",{children:[i.jsx("line",{x1:s,x2:s,y1:n,y2:o,stroke:r,strokeWidth:1}),i.jsx("rect",{x:s-J/2,y:u,width:J,height:m,fill:r})]},t.time)}),_&&i.jsx("path",{className:"ema200",d:_,fill:"none",stroke:"#888",strokeWidth:1.2}),O&&i.jsx("path",{className:"ema26",d:O,fill:"none",stroke:"#ff9900",strokeWidth:1.6}),W.map((t,e)=>i.jsx("circle",{className:"cross-marker "+(t.type==="bull"?"bull":"bear"),cx:t.x,cy:t.y,r:4},e))]}),i.jsxs("div",{className:"chart-legend",children:[i.jsxs("span",{className:"legend-item",children:[i.jsx("span",{className:"swatch ema26"}),`EMA${d}`]}),i.jsxs("span",{className:"legend-item",children:[i.jsx("span",{className:"swatch ema200"}),`EMA${g}`]}),i.jsxs("span",{className:"legend-item",children:[i.jsx("span",{className:"swatch bull"}),"Bull Cross"]}),i.jsxs("span",{className:"legend-item",children:[i.jsx("span",{className:"swatch bear"}),"Bear Cross"]})]})]})}export{nt as default};
