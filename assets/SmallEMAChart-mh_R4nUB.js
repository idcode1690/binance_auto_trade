import{r as f,j as i}from"./index-Cpp000v3.js";function G(k,F){const N=2/(F+1),$=[];let p=null;for(let d=0;d<k.length;d++){const g=k[d];if(g==null){$.push(null);continue}p==null?p=g:p=g*N+p*(1-N),$.push(p)}return $}function nt({interval:k="1m",limit:F=200,livePrice:N=null,onTrade:$=null,onCross:p=null,emaShort:d=26,emaLong:g=200,symbol:W="BTCUSDT"}){const[h,D]=f.useState([]),[Q,Y]=f.useState([]),[V,T]=f.useState([]),E=f.useRef(null),L=f.useRef(null);f.useEffect(()=>{let t=!1,e=null;async function s(){try{const n=`https://api.binance.com/api/v3/klines?symbol=${encodeURIComponent(W)}&interval=${k}&limit=${F}`,l=(await(await fetch(n)).json()).map(c=>({open:parseFloat(c[1]),high:parseFloat(c[2]),low:parseFloat(c[3]),close:parseFloat(c[4]),time:c[0]}));if(t)return;D(l)}catch(n){console.warn("fetch klines failed",n)}}try{const n=String(W||"BTCUSDT").toLowerCase(),a=`wss://stream.binance.com:9443/stream?streams=${`${n}@kline_${k}/${n}@trade`}`;e=new WebSocket(a),e.onmessage=l=>{try{const c=JSON.parse(l.data),r=c.data||c;if(r&&r.k){const u=r.k,m={open:parseFloat(u.o),high:parseFloat(u.h),low:parseFloat(u.l),close:parseFloat(u.c),time:u.t};D(y=>{if(!y||y.length===0)return[m];if(y[y.length-1].time===m.time){const M=y.slice(0,y.length-1);return M.push(m),M}else{const M=y.concat([m]);return M.length>F&&M.shift(),M}});return}if(r&&(r.p||r.price)){const u=parseFloat(r.p||r.price||r.P);if($&&isFinite(u))try{$(u)}catch{}}}catch{}},e.onerror=l=>console.warn("combined ws error",l)}catch(n){console.warn("failed to open combined websocket",n)}return s(),()=>{t=!0;try{e&&e.close()}catch{}}},[k,F]),f.useEffect(()=>{if(!h||h.length===0)return;const t=h.map(n=>n.close),e=G(t,d),s=G(t,g);Y(e),T(s),E.current=e.length?e[e.length-1]:null,L.current=s.length?s[s.length-1]:null},[h,d,g]);const C=f.useRef(null),S=f.useRef(null);f.useEffect(()=>{if(N==null)return;const t=Number(N);if(isFinite(t))return C.current=t,S.current==null&&(S.current=requestAnimationFrame(()=>{const e=C.current;C.current=null,S.current=null,D(s=>{if(!s||s.length===0)return s;const n=s.slice(),o=n[n.length-1];if(!o)return s;const a={...o,close:e,high:Math.max(o.high,e),low:Math.min(o.low,e)};return n[n.length-1]=a,n});try{if(E.current!=null&&L.current!=null){const s=2/(d+1),n=2/(g+1),o=e*s+E.current*(1-s),a=e*n+L.current*(1-n);E.current=o,L.current=a,Y(l=>{if(!l||l.length===0)return l;const c=l.slice();return c[c.length-1]=o,c}),T(l=>{if(!l||l.length===0)return l;const c=l.slice();return c[c.length-1]=a,c})}}catch{}})),()=>{S.current&&(cancelAnimationFrame(S.current),S.current=null)}},[N]);const q=600,U=160,b=2,H=h.length,R=Math.min(H,120),B=h.slice(-R),x=Q.slice(-R),w=V.slice(-R),X=B.map(t=>t.high),Z=B.map(t=>t.low),v=Math.max(...X),I=Math.min(...Z),A=(q-b*2)/(R-1||1),J=Math.max(1,A*.6),j=t=>b+(1-(t-I)/(v-I||1))*(U-b*2),K=t=>{let e="";for(let s=0;s<t.length;s++){const n=t[s];if(n==null)continue;const o=b+s*A,a=j(n);e+=e===""?`M ${o} ${a}`:` L ${o} ${a}`}return e},O=K(x),_=K(w),P=[];for(let t=1;t<R;t++){const e=x[t-1],s=w[t-1],n=x[t],o=w[t];if(n==null||o==null||e==null||s==null)continue;const a=e-s,l=n-o;if(a<=0&&l>0){const c=b+t*A,r=j((n+o)/2);P.push({x:c,y:r,type:"bull",idx:t})}else if(a>=0&&l<0){const c=b+t*A,r=j((n+o)/2);P.push({x:c,y:r,type:"bear",idx:t})}}const z=f.useRef(new Set);return f.useEffect(()=>{if(!p||!x||!w)return;const t=Math.min(x.length,w.length);if(t<2)return;const e=t-1,s=x[e-1],n=w[e-1],o=x[e],a=w[e];if(o==null||a==null||s==null||n==null)return;const l=s-n,c=o-a;let r=null;if(l<=0&&c>0?r="bull":l>=0&&c<0&&(r="bear"),r){const u=h&&h.length>0?h[h.length-1].time:Date.now(),m=`${u}:${r}`;if(!z.current.has(m)){z.current.add(m);try{p({type:r,time:u,price:h[h.length-1].close})}catch{}}}},[x,w]),H===0?i.jsx("div",{className:"meta",children:"Loading chart..."}):i.jsxs("div",{style:{width:"100%",overflow:"hidden"},children:[i.jsxs("svg",{className:"chart-svg",viewBox:`0 0 ${q} ${U}`,preserveAspectRatio:"none",style:{width:"100%",height:U},children:[B.map((t,e)=>{const s=b+e*A,n=j(t.high),o=j(t.low),a=j(t.open),l=j(t.close),r=t.close>=t.open?"#0f9d58":"#d93025",u=Math.min(a,l),m=Math.max(1,Math.abs(l-a));return i.jsxs("g",{children:[i.jsx("line",{x1:s,x2:s,y1:n,y2:o,stroke:r,strokeWidth:1}),i.jsx("rect",{x:s-J/2,y:u,width:J,height:m,fill:r})]},t.time)}),_&&i.jsx("path",{className:"ema200",d:_,fill:"none",stroke:"#888",strokeWidth:1.2}),O&&i.jsx("path",{className:"ema26",d:O,fill:"none",stroke:"#ff9900",strokeWidth:1.6}),P.map((t,e)=>i.jsx("circle",{className:"cross-marker "+(t.type==="bull"?"bull":"bear"),cx:t.x,cy:t.y,r:4},e))]}),i.jsxs("div",{className:"chart-legend",children:[i.jsxs("span",{className:"legend-item",children:[i.jsx("span",{className:"swatch ema26"}),`EMA${d}`]}),i.jsxs("span",{className:"legend-item",children:[i.jsx("span",{className:"swatch ema200"}),`EMA${g}`]}),i.jsxs("span",{className:"legend-item",children:[i.jsx("span",{className:"swatch bull"}),"Bull Cross"]}),i.jsxs("span",{className:"legend-item",children:[i.jsx("span",{className:"swatch bear"}),"Bear Cross"]})]})]})}export{nt as default};
