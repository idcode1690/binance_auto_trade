import{r as a,j as l}from"./index-B0JgOIwN.js";function ue(C,j){const V=2/(j+1),f=[];let d=null;for(let b=0;b<C.length;b++){const p=C[b];if(p==null){f.push(null);continue}d==null?d=p:d=p*V+d*(1-V),f.push(d)}return f}function Ne({interval:C="1m",limit:j=200,onCross:V=null,onPrice:f=null,emaShort:d=26,emaLong:b=200,symbol:p="BTCUSDT"}){const[g,W]=a.useState([]),[he,z]=a.useState(!0),[me,fe]=a.useState([]),[de,pe]=a.useState([]),ge=a.useRef(null),xe=a.useRef(null),A=a.useRef(null),D=a.useRef(null),I=a.useRef(!1);a.useRef(null),a.useRef(0);const J=a.useRef([]),U=a.useRef(!0),X=a.useRef(null);a.useEffect(()=>{let e=!1,s=null,t=null,n=null,c=null;function m(){try{const h=`wss://stream.binance.com:9443/ws/${String(p||"BTCUSDT").toLowerCase()}@trade`;t=new WebSocket(h),D.current=t,t.onmessage=o=>{try{const M=JSON.parse(o.data),i=parseFloat(M.p);if(!isFinite(i))return;if(W(r=>{if(!r||r.length===0)return r;const y=r.slice(),$=y[y.length-1];return $&&$.closed===!1?(y[y.length-1]={...$,close:i},y):r}),f)try{f(i)}catch{}}catch{}},t.onclose=()=>{e||(c=setTimeout(()=>m(),3e3))},t.onerror=()=>{}}catch{}}async function E(){z(!0),U.current=!0;try{const u=`https://api.binance.com/api/v3/klines?symbol=${encodeURIComponent(p)}&interval=${C}&limit=${j}`,o=await(await fetch(u)).json();let i=(Array.isArray(o)?o:[]).map(r=>{const y=Number(r[0]),$=parseFloat(r[1]),re=parseFloat(r[2]),ce=parseFloat(r[3]),ie=parseFloat(r[4]),O=Number(r[6]);return{time:y,open:isFinite($)?$:null,high:isFinite(re)?re:null,low:isFinite(ce)?ce:null,close:isFinite(ie)?ie:null,closed:isFinite(O)?O<=Date.now():!0,closeTime:isFinite(O)?O:null}});i.sort((r,y)=>r.time-y.time),W(i),z(!1),U.current=!1}catch{W([]),z(!1),U.current=!1}}function T(u){W(h=>{let o=h&&h.length?h.slice():[];if(!h||h.length===0)o=[u];else{const M=o[o.length-1];if(u.time===M.time)o[o.length-1]=u;else if(u.time>M.time)o.push(u),o.length>j&&(o=o.slice(o.length-j));else{const i=o.findIndex(r=>r.time===u.time);i>=0&&(o[i]=u)}}return o})}function w(){if(!I.current){I.current=!0;try{const h=`wss://stream.binance.com:9443/ws/${String(p||"BTCUSDT").toLowerCase()}@kline_${C}`;s=new WebSocket(h),A.current=s,s.onopen=()=>{},s.onclose=()=>{e||(n=setTimeout(()=>w(),3e3))},s.onerror=()=>{},s.onmessage=o=>{try{const i=JSON.parse(o.data).k;if(i){const r={open:parseFloat(i.o),high:parseFloat(i.h),low:parseFloat(i.l),close:parseFloat(i.c),time:i.t,closed:!!i.x};if(U.current){J.current=J.current||[],J.current.push(r);return}T(r)}}catch{}}}catch{}}}return E().then(()=>{w(),m()}),()=>{e=!0,n&&clearTimeout(n),c&&clearTimeout(c);try{A.current&&A.current.readyState!==WebSocket.CLOSED&&A.current.close()}catch{}try{D.current&&D.current.readyState!==WebSocket.CLOSED&&D.current.close()}catch{}I.current=!1}},[C,j,p]),a.useEffect(()=>{if(!g||g.length===0)return;const e=g.map(n=>n.close),s=ue(e,d),t=ue(e,b);if(fe(s),pe(t),ge.current=s.length?s[s.length-1]:null,xe.current=t.length?t[t.length-1]:null,f&&g.length>0){const n=g[g.length-1];if(n&&typeof n.close=="number"&&isFinite(n.close))try{f(n.close)}catch{}}},[g,d,b,f]);const H=600,[K,je]=a.useState(!0),P=K?266:154,S=2,N=g.length,[R,Z]=a.useState(80),k=10,Y=Math.max(k,j),x=Math.min(N,R),F=g.slice(-x),Q=me.slice(-x),_=de.slice(-x),q=a.useCallback(e=>{try{e.preventDefault()}catch{}const s=e.deltaY,t=Math.max(1,Math.round(R*.12));let n=R;if(s<0)n=Math.max(k,R-t);else if(s>0){const c=Math.min(Math.max(k,N||0),Y);n=Math.min(c,R+t)}n!==R&&Z(n)},[R,k,Y,N]),we=x>k,ye=x<Math.min(N,Y);a.useEffect(()=>{N&&Z(K?e=>Math.max(k,Math.round(e*.6)):e=>Math.min(Math.max(k,N||0,Y),Math.round(e/.6)))},[K]),a.useEffect(()=>{const e=X.current;if(e)return e.addEventListener("wheel",q,{passive:!1}),()=>{e.removeEventListener("wheel",q,{passive:!1})}},[q]);const ee=F.map(e=>{const s=[e.high,e.open,e.close,e.low].map(t=>Number(t)).filter(t=>isFinite(t));return s.length?Math.max(...s):null}).filter(e=>e!=null),te=F.map(e=>{const s=[e.low,e.open,e.close,e.high].map(t=>Number(t)).filter(t=>isFinite(t));return s.length?Math.min(...s):null}).filter(e=>e!=null);if(ee.length===0||te.length===0)return he?l.jsx("div",{className:"meta",children:"Loading chart..."}):l.jsxs("div",{className:"meta",children:[l.jsxs("div",{children:["No data for ",String(p)]}),l.jsxs("details",{style:{maxHeight:200,overflow:"auto"},children:[l.jsx("summary",{children:"Raw slice (first 20)"}),l.jsx("pre",{style:{whiteSpace:"pre-wrap",fontSize:12},children:JSON.stringify(F.slice(-20),null,2)})]})]});const Se=Math.max(...ee),se=Math.min(...te);let L=(H-S*2)/(x-1||1),B=Math.max(1,L*.6);const ne=S,Me=Math.max(S,Math.ceil(B/2)+1);L=(H-ne-Me)/(x-1||1),B=Math.max(1,L*.6);const v=e=>S+(1-(e-se)/(Se-se||1))*(P-S*2),le=e=>{let s="";for(let t=0;t<e.length;t++){const n=e[t];if(n==null)continue;const c=S+t*L,m=v(n);s+=s===""?`M ${c} ${m}`:` L ${c} ${m}`}return s},oe=le(Q),ae=le(_),G=[];for(let e=1;e<x&&!(e===x-1&&F.length&&!F[F.length-1].closed);e++){const s=Q[e-1],t=_[e-1],n=Q[e],c=_[e];if(n==null||c==null||s==null||t==null)continue;const m=s-t,E=n-c;if(m<=0&&E>0){const T=S+e*L,w=v((n+c)/2);G.push({x:T,y:w,type:"bull",idx:e})}else if(m>=0&&E<0){const T=S+e*L,w=v((n+c)/2);G.push({x:T,y:w,type:"bear",idx:e})}}return N===0?l.jsx("div",{className:"meta",children:"Loading chart..."}):l.jsxs("div",{ref:X,style:{width:"100%",overflow:"hidden",cursor:we?"zoom-in":ye?"zoom-out":"default"},children:[l.jsxs("svg",{className:"chart-svg",viewBox:`0 0 ${H} ${P}`,preserveAspectRatio:"xMidYMid meet",style:{width:"100%",height:"auto",display:"block"},children:[F.map((e,s)=>{if(![e.open,e.high,e.low,e.close].every(o=>isFinite(Number(o))))return null;const t=ne+s*L,n=v(e.high),c=v(e.low),m=v(e.open),E=v(e.close),w=e.close>=e.open?"#0f9d58":"#d93025",u=Math.min(m,E),h=Math.max(1,Math.abs(E-m));return l.jsxs("g",{children:[l.jsx("line",{x1:t,x2:t,y1:n,y2:c,stroke:w,strokeWidth:1}),l.jsx("rect",{x:t-B/2,y:u,width:B,height:h,fill:w})]},e.time)}),ae&&l.jsx("path",{className:"ema200",d:ae,fill:"none",stroke:"#888",strokeWidth:1.2}),oe&&l.jsx("path",{className:"ema26",d:oe,fill:"none",stroke:"#ff9900",strokeWidth:1.6}),G.map((e,s)=>l.jsx("circle",{className:"cross-marker "+(e.type==="bull"?"bull":"bear"),cx:e.x,cy:e.y,r:4},s))]}),l.jsxs("div",{className:"chart-legend",children:[l.jsxs("span",{className:"legend-item",children:[l.jsx("span",{className:"swatch ema26"}),`EMA${d}`]}),l.jsxs("span",{className:"legend-item",children:[l.jsx("span",{className:"swatch ema200"}),`EMA${b}`]}),l.jsxs("span",{className:"legend-item",children:[l.jsx("span",{className:"swatch bull"}),"Bull Cross"]}),l.jsxs("span",{className:"legend-item",children:[l.jsx("span",{className:"swatch bear"}),"Bear Cross"]})]})]})}export{Ne as default};
