import{r as o,j as l}from"./index-HOSVTdj4.js";function oe(k,w){const A=2/(w+1),M=[];let d=null;for(let x=0;x<k.length;x++){const f=k[x];if(f==null){M.push(null);continue}d==null?d=f:d=f*A+d*(1-A),M.push(d)}return M}function Me({interval:k="1m",limit:w=200,onCross:A=null,emaShort:M=26,emaLong:d=200,symbol:x="BTCUSDT"}){const[f,T]=o.useState([]),[ae,D]=o.useState(!0),[re,ce]=o.useState([]),[ie,ue]=o.useState([]),he=o.useRef(null),me=o.useRef(null),F=o.useRef(null);o.useRef(null);const W=o.useRef(!1);o.useRef(null),o.useRef(0);const Y=o.useRef([]),L=o.useRef(!0),J=o.useRef(null);o.useEffect(()=>{let e=!1,t=null,s=null;async function a(){D(!0),L.current=!0;try{const r=`https://api.binance.com/api/v3/klines?symbol=${encodeURIComponent(x)}&interval=${k}&limit=${w}`,n=await(await fetch(r)).json();let c=(Array.isArray(n)?n:[]).map(i=>{const H=Number(i[0]),te=parseFloat(i[1]),se=parseFloat(i[2]),ne=parseFloat(i[3]),le=parseFloat(i[4]),C=Number(i[6]);return{time:H,open:isFinite(te)?te:null,high:isFinite(se)?se:null,low:isFinite(ne)?ne:null,close:isFinite(le)?le:null,closed:isFinite(C)?C<=Date.now():!0,closeTime:isFinite(C)?C:null}});c.sort((i,H)=>i.time-H.time),T(c),D(!1),L.current=!1}catch{T([]),D(!1),L.current=!1}}function u(r){T(h=>{let n=h&&h.length?h.slice():[];if(!h||h.length===0)n=[r];else{const v=n[n.length-1];if(r.time===v.time)n[n.length-1]=r;else if(r.time>v.time)n.push(r),n.length>w&&(n=n.slice(n.length-w));else{const c=n.findIndex(i=>i.time===r.time);c>=0&&(n[c]=r)}}return n})}function m(){if(!W.current){W.current=!0;try{const h=`wss://stream.binance.com:9443/ws/${String(x||"BTCUSDT").toLowerCase()}@kline_${k}`;t=new WebSocket(h),F.current=t,t.onopen=()=>{},t.onclose=()=>{e||(s=setTimeout(()=>m(),3e3))},t.onerror=()=>{},t.onmessage=n=>{try{const c=JSON.parse(n.data).k;if(c){const i={open:parseFloat(c.o),high:parseFloat(c.h),low:parseFloat(c.l),close:parseFloat(c.c),time:c.t,closed:!!c.x};if(L.current){Y.current=Y.current||[],Y.current.push(i);return}u(i)}}catch{}}}catch{}}}return a().then(()=>{m()}),()=>{e=!0,s&&clearTimeout(s);try{F.current&&F.current.readyState!==WebSocket.CLOSED&&F.current.close()}catch{}W.current=!1}},[k,w,x]),o.useEffect(()=>{if(!f||f.length===0)return;const e=f.map(a=>a.close),t=oe(e,M),s=oe(e,d);ce(t),ue(s),he.current=t.length?t[t.length-1]:null,me.current=s.length?s[s.length-1]:null},[f,M,d]);const U=600,[B,ge]=o.useState(!0),K=B?266:154,g=2,y=f.length,[j,V]=o.useState(80),S=10,E=Math.max(S,w),p=Math.min(y,j),N=f.slice(-p),z=re.slice(-p),I=ie.slice(-p),O=o.useCallback(e=>{try{e.preventDefault()}catch{}const t=e.deltaY,s=Math.max(1,Math.round(j*.12));let a=j;if(t<0)a=Math.max(S,j-s);else if(t>0){const u=Math.min(Math.max(S,y||0),E);a=Math.min(u,j+s)}a!==j&&V(a)},[j,S,E,y]),fe=p>S,de=p<Math.min(y,E);o.useEffect(()=>{y&&V(B?e=>Math.max(S,Math.round(e*.6)):e=>Math.min(Math.max(S,y||0,E),Math.round(e/.6)))},[B]),o.useEffect(()=>{const e=J.current;if(e)return e.addEventListener("wheel",O,{passive:!1}),()=>{e.removeEventListener("wheel",O,{passive:!1})}},[O]);const Z=N.map(e=>{const t=[e.high,e.open,e.close,e.low].map(s=>Number(s)).filter(s=>isFinite(s));return t.length?Math.max(...t):null}).filter(e=>e!=null),Q=N.map(e=>{const t=[e.low,e.open,e.close,e.high].map(s=>Number(s)).filter(s=>isFinite(s));return t.length?Math.min(...t):null}).filter(e=>e!=null);if(Z.length===0||Q.length===0)return ae?l.jsx("div",{className:"meta",children:"Loading chart..."}):l.jsxs("div",{className:"meta",children:[l.jsxs("div",{children:["No data for ",String(x)]}),l.jsxs("details",{style:{maxHeight:200,overflow:"auto"},children:[l.jsx("summary",{children:"Raw slice (first 20)"}),l.jsx("pre",{style:{whiteSpace:"pre-wrap",fontSize:12},children:JSON.stringify(N.slice(-20),null,2)})]})]});const pe=Math.max(...Z),_=Math.min(...Q);let R=(U-g*2)/(p-1||1),$=Math.max(1,R*.6);const q=g,xe=Math.max(g,Math.ceil($/2)+1);R=(U-q-xe)/(p-1||1),$=Math.max(1,R*.6);const b=e=>g+(1-(e-_)/(pe-_||1))*(K-g*2),G=e=>{let t="";for(let s=0;s<e.length;s++){const a=e[s];if(a==null)continue;const u=g+s*R,m=b(a);t+=t===""?`M ${u} ${m}`:` L ${u} ${m}`}return t},X=G(z),ee=G(I),P=[];for(let e=1;e<p&&!(e===p-1&&N.length&&!N[N.length-1].closed);e++){const t=z[e-1],s=I[e-1],a=z[e],u=I[e];if(a==null||u==null||t==null||s==null)continue;const m=t-s,r=a-u;if(m<=0&&r>0){const h=g+e*R,n=b((a+u)/2);P.push({x:h,y:n,type:"bull",idx:e})}else if(m>=0&&r<0){const h=g+e*R,n=b((a+u)/2);P.push({x:h,y:n,type:"bear",idx:e})}}return y===0?l.jsx("div",{className:"meta",children:"Loading chart..."}):l.jsxs("div",{ref:J,style:{width:"100%",overflow:"hidden",cursor:fe?"zoom-in":de?"zoom-out":"default"},children:[l.jsxs("svg",{className:"chart-svg",viewBox:`0 0 ${U} ${K}`,preserveAspectRatio:"xMidYMid meet",style:{width:"100%",height:"auto",display:"block"},children:[N.map((e,t)=>{if(![e.open,e.high,e.low,e.close].every(i=>isFinite(Number(i))))return null;const s=q+t*R,a=b(e.high),u=b(e.low),m=b(e.open),r=b(e.close),n=e.close>=e.open?"#0f9d58":"#d93025",v=Math.min(m,r),c=Math.max(1,Math.abs(r-m));return l.jsxs("g",{children:[l.jsx("line",{x1:s,x2:s,y1:a,y2:u,stroke:n,strokeWidth:1}),l.jsx("rect",{x:s-$/2,y:v,width:$,height:c,fill:n})]},e.time)}),ee&&l.jsx("path",{className:"ema200",d:ee,fill:"none",stroke:"#888",strokeWidth:1.2}),X&&l.jsx("path",{className:"ema26",d:X,fill:"none",stroke:"#ff9900",strokeWidth:1.6}),P.map((e,t)=>l.jsx("circle",{className:"cross-marker "+(e.type==="bull"?"bull":"bear"),cx:e.x,cy:e.y,r:4},t))]}),l.jsxs("div",{className:"chart-legend",children:[l.jsxs("span",{className:"legend-item",children:[l.jsx("span",{className:"swatch ema26"}),`EMA${M}`]}),l.jsxs("span",{className:"legend-item",children:[l.jsx("span",{className:"swatch ema200"}),`EMA${d}`]}),l.jsxs("span",{className:"legend-item",children:[l.jsx("span",{className:"swatch bull"}),"Bull Cross"]}),l.jsxs("span",{className:"legend-item",children:[l.jsx("span",{className:"swatch bear"}),"Bear Cross"]})]})]})}export{Me as default};
