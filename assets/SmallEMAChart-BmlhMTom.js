import{r as f,j as a}from"./index-HEEtWAj7.js";function Z(N,M){const j=2/(M+1),w=[];let p=null;for(let g=0;g<N.length;g++){const x=N[g];if(x==null){w.push(null);continue}p==null?p=x:p=x*j+p*(1-j),w.push(p)}return w}function lt({interval:N="1m",limit:M=200,livePrice:j=null,onTrade:w=null,onCross:p=null,emaShort:g=26,emaLong:x=200,symbol:E="BTCUSDT"}){const[u,L]=f.useState([]),[tt,B]=f.useState(!0),[k,I]=f.useState([]),[S,q]=f.useState([]),D=f.useRef(null),U=f.useRef(null);f.useEffect(()=>{let t=!1,e=null;async function s(){B(!0);try{const n=`https://api.binance.com/api/v3/klines?symbol=${encodeURIComponent(E)}&interval=${N}&limit=${M}`,c=(await(await fetch(n)).json()).map(l=>({open:parseFloat(l[1]),high:parseFloat(l[2]),low:parseFloat(l[3]),close:parseFloat(l[4]),time:l[0]}));if(t)return;L(c),B(!1)}catch(n){console.warn("fetch klines failed",n),L([]),B(!1)}}try{const n=String(E||"BTCUSDT").toLowerCase(),i=`wss://stream.binance.com:9443/stream?streams=${`${n}@kline_${N}/${n}@trade`}`;e=new WebSocket(i),e.onmessage=c=>{try{const l=JSON.parse(c.data),r=l.data||l;if(r&&r.k){const h=r.k,m={open:parseFloat(h.o),high:parseFloat(h.h),low:parseFloat(h.l),close:parseFloat(h.c),time:h.t};L(d=>{if(!d||d.length===0)return[m];if(d[d.length-1].time===m.time){const $=d.slice(0,d.length-1);return $.push(m),$}else{const $=d.concat([m]);return $.length>M&&$.shift(),$}});return}if(r&&(r.p||r.price)){const h=parseFloat(r.p||r.price||r.P);if(w&&isFinite(h))try{w(h)}catch{}}}catch{}},e.onerror=c=>console.warn("combined ws error",c)}catch(n){console.warn("failed to open combined websocket",n)}return s(),()=>{t=!0;try{e&&e.close()}catch{}}},[N,M,E,w]),f.useEffect(()=>{if(!u||u.length===0)return;const t=u.map(n=>n.close),e=Z(t,g),s=Z(t,x);I(e),q(s),D.current=e.length?e[e.length-1]:null,U.current=s.length?s[s.length-1]:null},[u,g,x]);const C=f.useRef(null),F=f.useRef(null);f.useEffect(()=>{if(j==null)return;const t=Number(j);if(isFinite(t))return C.current=t,F.current==null&&(F.current=requestAnimationFrame(()=>{const e=C.current;C.current=null,F.current=null,L(s=>{if(!s||s.length===0)return s;const n=s.slice(),o=n[n.length-1];if(!o)return s;const i={...o,close:e,high:Math.max(o.high,e),low:Math.min(o.low,e)};return n[n.length-1]=i,n});try{if(D.current!=null&&U.current!=null){const s=2/(g+1),n=2/(x+1),o=e*s+D.current*(1-s),i=e*n+U.current*(1-n);D.current=o,U.current=i,I(c=>{if(!c||c.length===0)return c;const l=c.slice();return l[l.length-1]=o,l}),q(c=>{if(!c||c.length===0)return c;const l=c.slice();return l[l.length-1]=i,l})}}catch{}})),()=>{F.current&&(cancelAnimationFrame(F.current),F.current=null)}},[j]);const H=600,P=160,y=2,J=u.length,R=Math.min(J,120),W=u.slice(-R),Y=k.slice(-R),T=S.slice(-R),K=f.useRef(new Set);f.useEffect(()=>{if(!p||!k||!S)return;const t=Math.min(k.length,S.length);if(t<2)return;const e=t-1,s=k[e-1],n=S[e-1],o=k[e],i=S[e];if(o==null||i==null||s==null||n==null)return;const c=s-n,l=o-i;let r=null;if(c<=0&&l>0?r="bull":c>=0&&l<0&&(r="bear"),r){const h=u&&u.length>0?u[u.length-1].time:Date.now(),m=`${h}:${r}`;if(!K.current.has(m)){K.current.add(m);try{p({type:r,time:h,price:u[u.length-1].close})}catch{}}}},[k,S,p,u]);const O=W.map(t=>Number(t.high)).filter(t=>isFinite(t)),_=W.map(t=>Number(t.low)).filter(t=>isFinite(t));if(O.length===0||_.length===0)return tt?a.jsx("div",{className:"meta",children:"Loading chart..."}):a.jsxs("div",{className:"meta",children:["No data for ",String(E)]});const et=Math.max(...O),z=Math.min(..._),A=(H-y*2)/(R-1||1),G=Math.max(1,A*.6),b=t=>y+(1-(t-z)/(et-z||1))*(P-y*2),Q=t=>{let e="";for(let s=0;s<t.length;s++){const n=t[s];if(n==null)continue;const o=y+s*A,i=b(n);e+=e===""?`M ${o} ${i}`:` L ${o} ${i}`}return e},V=Q(Y),X=Q(T),v=[];for(let t=1;t<R;t++){const e=Y[t-1],s=T[t-1],n=Y[t],o=T[t];if(n==null||o==null||e==null||s==null)continue;const i=e-s,c=n-o;if(i<=0&&c>0){const l=y+t*A,r=b((n+o)/2);v.push({x:l,y:r,type:"bull",idx:t})}else if(i>=0&&c<0){const l=y+t*A,r=b((n+o)/2);v.push({x:l,y:r,type:"bear",idx:t})}}return J===0?a.jsx("div",{className:"meta",children:"Loading chart..."}):a.jsxs("div",{style:{width:"100%",overflow:"hidden"},children:[a.jsxs("svg",{className:"chart-svg",viewBox:`0 0 ${H} ${P}`,preserveAspectRatio:"none",style:{width:"100%",height:P},children:[W.map((t,e)=>{if(![t.open,t.high,t.low,t.close].every(d=>isFinite(Number(d))))return null;const s=y+e*A,n=b(t.high),o=b(t.low),i=b(t.open),c=b(t.close),r=t.close>=t.open?"#0f9d58":"#d93025",h=Math.min(i,c),m=Math.max(1,Math.abs(c-i));return a.jsxs("g",{children:[a.jsx("line",{x1:s,x2:s,y1:n,y2:o,stroke:r,strokeWidth:1}),a.jsx("rect",{x:s-G/2,y:h,width:G,height:m,fill:r})]},t.time)}),X&&a.jsx("path",{className:"ema200",d:X,fill:"none",stroke:"#888",strokeWidth:1.2}),V&&a.jsx("path",{className:"ema26",d:V,fill:"none",stroke:"#ff9900",strokeWidth:1.6}),v.map((t,e)=>a.jsx("circle",{className:"cross-marker "+(t.type==="bull"?"bull":"bear"),cx:t.x,cy:t.y,r:4},e))]}),a.jsxs("div",{className:"chart-legend",children:[a.jsxs("span",{className:"legend-item",children:[a.jsx("span",{className:"swatch ema26"}),`EMA${g}`]}),a.jsxs("span",{className:"legend-item",children:[a.jsx("span",{className:"swatch ema200"}),`EMA${x}`]}),a.jsxs("span",{className:"legend-item",children:[a.jsx("span",{className:"swatch bull"}),"Bull Cross"]}),a.jsxs("span",{className:"legend-item",children:[a.jsx("span",{className:"swatch bear"}),"Bear Cross"]})]})]})}export{lt as default};
