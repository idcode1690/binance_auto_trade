import{r as f,j as i}from"./index-SFSuy2Bm.js";function z(j,S){const k=2/(S+1),N=[];let p=null;for(let d=0;d<j.length;d++){const g=j[d];if(g==null){N.push(null);continue}p==null?p=g:p=g*k+p*(1-k),N.push(p)}return N}function tt({interval:j="1m",limit:S=200,livePrice:k=null,onTrade:N=null,onCross:p=null,emaShort:d=26,emaLong:g=200}){const[u,L]=f.useState([]),[G,B]=f.useState([]),[I,U]=f.useState([]),E=f.useRef(null),R=f.useRef(null);f.useEffect(()=>{let t=!1,e=null;async function n(){try{const c=`https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=${j}&limit=${S}`,l=(await(await fetch(c)).json()).map(s=>({open:parseFloat(s[1]),high:parseFloat(s[2]),low:parseFloat(s[3]),close:parseFloat(s[4]),time:s[0]}));if(t)return;L(l)}catch(c){console.warn("fetch klines failed",c)}}try{const o=`wss://stream.binance.com:9443/stream?streams=${`btcusdt@kline_${j}/btcusdt@trade`}`;e=new WebSocket(o),e.onmessage=r=>{try{const l=JSON.parse(r.data),s=l.data||l;if(s&&s.k){const a=s.k,m={open:parseFloat(a.o),high:parseFloat(a.h),low:parseFloat(a.l),close:parseFloat(a.c),time:a.t};L(h=>{if(!h||h.length===0)return[m];if(h[h.length-1].time===m.time){const F=h.slice(0,h.length-1);return F.push(m),F}else{const F=h.concat([m]);return F.length>S&&F.shift(),F}});return}if(s&&(s.p||s.price)){const a=parseFloat(s.p||s.price||s.P);if(N&&isFinite(a))try{N(a)}catch{}}}catch{}},e.onerror=r=>console.warn("combined ws error",r)}catch(c){console.warn("failed to open combined websocket",c)}return n(),()=>{t=!0;try{e&&e.close()}catch{}}},[j,S]),f.useEffect(()=>{if(!u||u.length===0)return;const t=u.map(c=>c.close),e=z(t,d),n=z(t,g);B(e),U(n),E.current=e.length?e[e.length-1]:null,R.current=n.length?n[n.length-1]:null},[u,d,g]);const D=f.useRef(null),M=f.useRef(null);f.useEffect(()=>{if(k==null)return;const t=Number(k);if(isFinite(t))return D.current=t,M.current==null&&(M.current=requestAnimationFrame(()=>{const e=D.current;D.current=null,M.current=null,L(n=>{if(!n||n.length===0)return n;const c=n.slice(),o=c[c.length-1];if(!o)return n;const r={...o,close:e,high:Math.max(o.high,e),low:Math.min(o.low,e)};return c[c.length-1]=r,c});try{if(E.current!=null&&R.current!=null){const n=2/(d+1),c=2/(g+1),o=e*n+E.current*(1-n),r=e*c+R.current*(1-c);E.current=o,R.current=r,B(l=>{if(!l||l.length===0)return l;const s=l.slice();return s[s.length-1]=o,s}),U(l=>{if(!l||l.length===0)return l;const s=l.slice();return s[s.length-1]=r,s})}}catch{}})),()=>{M.current&&(cancelAnimationFrame(M.current),M.current=null)}},[k]);const C=600,P=160,y=2,T=u.length,$=Math.min(T,120),W=u.slice(-$),x=G.slice(-$),w=I.slice(-$),Q=W.map(t=>t.high),V=W.map(t=>t.low),X=Math.max(...Q),q=Math.min(...V),A=(C-y*2)/($-1||1),H=Math.max(1,A*.6),b=t=>y+(1-(t-q)/(X-q||1))*(P-y*2),J=t=>{let e="";for(let n=0;n<t.length;n++){const c=t[n];if(c==null)continue;const o=y+n*A,r=b(c);e+=e===""?`M ${o} ${r}`:` L ${o} ${r}`}return e},K=J(x),O=J(w),Y=[];for(let t=1;t<$;t++){const e=x[t-1],n=w[t-1],c=x[t],o=w[t];if(c==null||o==null||e==null||n==null)continue;const r=e-n,l=c-o;if(r<=0&&l>0){const s=y+t*A,a=b((c+o)/2);Y.push({x:s,y:a,type:"bull",idx:t})}else if(r>=0&&l<0){const s=y+t*A,a=b((c+o)/2);Y.push({x:s,y:a,type:"bear",idx:t})}}const _=f.useRef(new Set);return f.useEffect(()=>{if(!p||!x||!w)return;const t=Math.min(x.length,w.length);if(t<2)return;const e=t-1,n=x[e-1],c=w[e-1],o=x[e],r=w[e];if(o==null||r==null||n==null||c==null)return;const l=n-c,s=o-r;let a=null;if(l<=0&&s>0?a="bull":l>=0&&s<0&&(a="bear"),a){const m=u&&u.length>0?u[u.length-1].time:Date.now(),h=`${m}:${a}`;if(!_.current.has(h)){_.current.add(h);try{p({type:a,time:m,price:u[u.length-1].close})}catch{}}}},[x,w]),T===0?i.jsx("div",{className:"meta",children:"Loading chart..."}):i.jsxs("div",{style:{width:"100%",overflow:"hidden"},children:[i.jsxs("svg",{className:"chart-svg",viewBox:`0 0 ${C} ${P}`,preserveAspectRatio:"none",style:{width:"100%",height:P},children:[W.map((t,e)=>{const n=y+e*A,c=b(t.high),o=b(t.low),r=b(t.open),l=b(t.close),a=t.close>=t.open?"#0f9d58":"#d93025",m=Math.min(r,l),h=Math.max(1,Math.abs(l-r));return i.jsxs("g",{children:[i.jsx("line",{x1:n,x2:n,y1:c,y2:o,stroke:a,strokeWidth:1}),i.jsx("rect",{x:n-H/2,y:m,width:H,height:h,fill:a})]},t.time)}),O&&i.jsx("path",{className:"ema200",d:O,fill:"none",stroke:"#888",strokeWidth:1.2}),K&&i.jsx("path",{className:"ema26",d:K,fill:"none",stroke:"#ff9900",strokeWidth:1.6}),Y.map((t,e)=>i.jsx("circle",{className:"cross-marker "+(t.type==="bull"?"bull":"bear"),cx:t.x,cy:t.y,r:4},e))]}),i.jsxs("div",{className:"chart-legend",children:[i.jsxs("span",{className:"legend-item",children:[i.jsx("span",{className:"swatch ema26"}),`EMA${d}`]}),i.jsxs("span",{className:"legend-item",children:[i.jsx("span",{className:"swatch ema200"}),`EMA${g}`]}),i.jsxs("span",{className:"legend-item",children:[i.jsx("span",{className:"swatch bull"}),"Bull Cross"]}),i.jsxs("span",{className:"legend-item",children:[i.jsx("span",{className:"swatch bear"}),"Bear Cross"]})]})]})}export{tt as default};
