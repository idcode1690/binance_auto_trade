import{r as u,j as r}from"./index-su_aySey.js";function st(k,S){const F=2/(S+1),b=[];let p=null;for(let g=0;g<k.length;g++){const x=k[g];if(x==null){b.push(null);continue}p==null?p=x:p=x*F+p*(1-F),b.push(p)}return b}function mt({interval:k="1m",limit:S=200,livePrice:F=null,onTrade:b=null,onCross:p=null,emaShort:g=26,emaLong:x=200,symbol:D="BTCUSDT"}){const[h,W]=u.useState([]),[ct,P]=u.useState(!0),[$,H]=u.useState([]),[R,J]=u.useState([]),U=u.useRef(null),Y=u.useRef(null);u.useEffect(()=>{let t=!1,n=null;async function s(){P(!0);try{const e=`https://api.binance.com/api/v3/klines?symbol=${encodeURIComponent(D)}&interval=${k}&limit=${S}`,o=(await(await fetch(e)).json()).map(l=>({open:parseFloat(l[1]),high:parseFloat(l[2]),low:parseFloat(l[3]),close:parseFloat(l[4]),time:l[0]}));if(t)return;W(o),P(!1)}catch(e){console.warn("fetch klines failed",e),W([]),P(!1)}}try{const e=String(D||"BTCUSDT").toLowerCase(),i=`wss://stream.binance.com:9443/stream?streams=${`${e}@kline_${k}/${e}@trade`}`;n=new WebSocket(i),n.onmessage=o=>{try{const l=JSON.parse(o.data),a=l.data||l;if(a&&a.k){const f=a.k,m={open:parseFloat(f.o),high:parseFloat(f.h),low:parseFloat(f.l),close:parseFloat(f.c),time:f.t};W(d=>{if(!d||d.length===0)return[m];if(d[d.length-1].time===m.time){const A=d.slice(0,d.length-1);return A.push(m),A}else{const A=d.concat([m]);return A.length>S&&A.shift(),A}});return}if(a&&(a.p||a.price)){const f=parseFloat(a.p||a.price||a.P);if(b&&isFinite(f))try{b(f)}catch{}}}catch{}},n.onerror=o=>console.warn("combined ws error",o)}catch(e){console.warn("failed to open combined websocket",e)}return s(),()=>{t=!0;try{n&&n.close()}catch{}}},[k,S,D,b]),u.useEffect(()=>{if(!h||h.length===0)return;const t=h.map(e=>e.close),n=st(t,g),s=st(t,x);H(n),J(s),U.current=n.length?n[n.length-1]:null,Y.current=s.length?s[s.length-1]:null},[h,g,x]);const v=u.useRef(null),L=u.useRef(null);u.useEffect(()=>{if(F==null)return;const t=Number(F);if(isFinite(t))return v.current=t,L.current==null&&(L.current=requestAnimationFrame(()=>{const n=v.current;v.current=null,L.current=null,W(s=>{if(!s||s.length===0)return s;const e=s.slice(),c=e[e.length-1];if(!c)return s;const i={...c,close:n,high:Math.max(c.high,n),low:Math.min(c.low,n)};return e[e.length-1]=i,e});try{if(U.current!=null&&Y.current!=null){const s=2/(g+1),e=2/(x+1),c=n*s+U.current*(1-s),i=n*e+Y.current*(1-e);U.current=c,Y.current=i,H(o=>{if(!o||o.length===0)return o;const l=o.slice();return l[l.length-1]=c,l}),J(o=>{if(!o||o.length===0)return o;const l=o.slice();return l[l.length-1]=i,l})}}catch{}})),()=>{L.current&&(cancelAnimationFrame(L.current),L.current=null)}},[F]);const I=600,T=160,w=2,E=h.length,[M,lt]=u.useState(120),C=10,V=Math.max(C,S),y=Math.min(E,M),z=h.slice(-y),O=$.slice(-y),Z=R.slice(-y),ot=u.useCallback(t=>{try{t.preventDefault()}catch{}const n=t.deltaY,s=Math.max(1,Math.round(M*.12));let e=M;if(n<0)e=Math.max(C,M-s);else if(n>0){const c=Math.min(Math.max(C,E||0),V);e=Math.min(c,M+s)}e!==M&&lt(e)},[M,C,V,E]),at=y>C,rt=y<Math.min(E,V),K=u.useRef(new Set);u.useEffect(()=>{if(!p||!$||!R)return;const t=Math.min($.length,R.length);if(t<2)return;const n=t-1,s=$[n-1],e=R[n-1],c=$[n],i=R[n];if(c==null||i==null||s==null||e==null)return;const o=s-e,l=c-i;let a=null;if(o<=0&&l>0?a="bull":o>=0&&l<0&&(a="bear"),a){const f=h&&h.length>0?h[h.length-1].time:Date.now(),m=`${f}:${a}`;if(!K.current.has(m)){K.current.add(m);try{p({type:a,time:f,price:h[h.length-1].close})}catch{}}}},[$,R,p,h]);const _=z.map(t=>Number(t.high)).filter(t=>isFinite(t)),G=z.map(t=>Number(t.low)).filter(t=>isFinite(t));if(_.length===0||G.length===0)return ct?r.jsx("div",{className:"meta",children:"Loading chart..."}):r.jsxs("div",{className:"meta",children:["No data for ",String(D)]});const it=Math.max(..._),Q=Math.min(...G);let N=(I-w*2)/(y-1||1),B=Math.max(1,N*.6);const X=w,ut=Math.max(w,Math.ceil(B/2)+1);N=(I-X-ut)/(y-1||1),B=Math.max(1,N*.6);const j=t=>w+(1-(t-Q)/(it-Q||1))*(T-w*2),tt=t=>{let n="";for(let s=0;s<t.length;s++){const e=t[s];if(e==null)continue;const c=w+s*N,i=j(e);n+=n===""?`M ${c} ${i}`:` L ${c} ${i}`}return n},et=tt(O),nt=tt(Z),q=[];for(let t=1;t<y;t++){const n=O[t-1],s=Z[t-1],e=O[t],c=Z[t];if(e==null||c==null||n==null||s==null)continue;const i=n-s,o=e-c;if(i<=0&&o>0){const l=w+t*N,a=j((e+c)/2);q.push({x:l,y:a,type:"bull",idx:t})}else if(i>=0&&o<0){const l=w+t*N,a=j((e+c)/2);q.push({x:l,y:a,type:"bear",idx:t})}}return E===0?r.jsx("div",{className:"meta",children:"Loading chart..."}):r.jsxs("div",{onWheel:ot,style:{width:"100%",overflow:"hidden",cursor:at?"zoom-in":rt?"zoom-out":"default"},children:[r.jsxs("svg",{className:"chart-svg",viewBox:`0 0 ${I} ${T}`,preserveAspectRatio:"none",style:{width:"100%",height:T},children:[z.map((t,n)=>{if(![t.open,t.high,t.low,t.close].every(d=>isFinite(Number(d))))return null;const s=X+n*N,e=j(t.high),c=j(t.low),i=j(t.open),o=j(t.close),a=t.close>=t.open?"#0f9d58":"#d93025",f=Math.min(i,o),m=Math.max(1,Math.abs(o-i));return r.jsxs("g",{children:[r.jsx("line",{x1:s,x2:s,y1:e,y2:c,stroke:a,strokeWidth:1}),r.jsx("rect",{x:s-B/2,y:f,width:B,height:m,fill:a})]},t.time)}),nt&&r.jsx("path",{className:"ema200",d:nt,fill:"none",stroke:"#888",strokeWidth:1.2}),et&&r.jsx("path",{className:"ema26",d:et,fill:"none",stroke:"#ff9900",strokeWidth:1.6}),q.map((t,n)=>r.jsx("circle",{className:"cross-marker "+(t.type==="bull"?"bull":"bear"),cx:t.x,cy:t.y,r:4},n))]}),r.jsxs("div",{className:"chart-legend",children:[r.jsxs("span",{className:"legend-item",children:[r.jsx("span",{className:"swatch ema26"}),`EMA${g}`]}),r.jsxs("span",{className:"legend-item",children:[r.jsx("span",{className:"swatch ema200"}),`EMA${x}`]}),r.jsxs("span",{className:"legend-item",children:[r.jsx("span",{className:"swatch bull"}),"Bull Cross"]}),r.jsxs("span",{className:"legend-item",children:[r.jsx("span",{className:"swatch bear"}),"Bear Cross"]})]})]})}export{mt as default};
