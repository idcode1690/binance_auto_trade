import{r as f,j as a}from"./index-DcTkBfOX.js";function st(k,S){const F=2/(S+1),M=[];let p=null;for(let g=0;g<k.length;g++){const x=k[g];if(x==null){M.push(null);continue}p==null?p=x:p=x*F+p*(1-F),M.push(p)}return M}function mt({interval:k="1m",limit:S=200,livePrice:F=null,onTrade:M=null,onCross:p=null,emaShort:g=26,emaLong:x=200,symbol:D="BTCUSDT"}){const[u,W]=f.useState([]),[lt,P]=f.useState(!0),[$,Z]=f.useState([]),[R,q]=f.useState([]),Y=f.useRef(null),U=f.useRef(null);f.useEffect(()=>{let t=!1,s=null;async function n(){P(!0);try{const e=`https://api.binance.com/api/v3/klines?symbol=${encodeURIComponent(D)}&interval=${k}&limit=${S}`,o=(await(await fetch(e)).json()).map(c=>({open:parseFloat(c[1]),high:parseFloat(c[2]),low:parseFloat(c[3]),close:parseFloat(c[4]),closed:!0,time:c[0]}));if(t)return;W(o),P(!1)}catch(e){console.warn("fetch klines failed",e),W([]),P(!1)}}try{const e=String(D||"BTCUSDT").toLowerCase(),r=`wss://stream.binance.com:9443/stream?streams=${`${e}@kline_${k}/${e}@trade`}`;s=new WebSocket(r),s.onmessage=o=>{try{const c=JSON.parse(o.data),i=c.data||c;if(i&&i.k){const h=i.k,d={open:parseFloat(h.o),high:parseFloat(h.h),low:parseFloat(h.l),close:parseFloat(h.c),time:h.t,closed:!!h.x};W(m=>{if(!m||m.length===0)return[d];if(m[m.length-1].time===d.time){const A=m.slice(0,m.length-1);return A.push(d),A}else{const A=m.concat([d]);return A.length>S&&A.shift(),A}});return}if(i&&(i.p||i.price)){const h=parseFloat(i.p||i.price||i.P);if(M&&isFinite(h))try{M(h)}catch{}}}catch{}},s.onerror=o=>console.warn("combined ws error",o)}catch(e){console.warn("failed to open combined websocket",e)}return n(),()=>{t=!0;try{s&&s.close()}catch{}}},[k,S,D,M]),f.useEffect(()=>{if(!u||u.length===0)return;const t=u.map(e=>e.close),s=st(t,g),n=st(t,x);Z(s),q(n),Y.current=s.length?s[s.length-1]:null,U.current=n.length?n[n.length-1]:null},[u,g,x]);const v=f.useRef(null),L=f.useRef(null);f.useEffect(()=>{if(F==null)return;const t=Number(F);if(isFinite(t))return v.current=t,L.current==null&&(L.current=requestAnimationFrame(()=>{const s=v.current;v.current=null,L.current=null,W(n=>{if(!n||n.length===0)return n;const e=n.slice(),l=e[e.length-1];if(!l)return n;const r={...l,close:s,high:Math.max(l.high,s),low:Math.min(l.low,s)};return e[e.length-1]=r,e});try{if(Y.current!=null&&U.current!=null){const n=2/(g+1),e=2/(x+1),l=s*n+Y.current*(1-n),r=s*e+U.current*(1-e);Y.current=l,U.current=r,Z(o=>{if(!o||o.length===0)return o;const c=o.slice();return c[c.length-1]=l,c}),q(o=>{if(!o||o.length===0)return o;const c=o.slice();return c[c.length-1]=r,c})}}catch{}})),()=>{L.current&&(cancelAnimationFrame(L.current),L.current=null)}},[F]);const I=600,H=160,w=2,E=u.length,[b,ct]=f.useState(120),C=10,T=Math.max(C,S),y=Math.min(E,b),V=u.slice(-y),z=$.slice(-y),K=R.slice(-y),ot=f.useCallback(t=>{try{t.preventDefault()}catch{}const s=t.deltaY,n=Math.max(1,Math.round(b*.12));let e=b;if(s<0)e=Math.max(C,b-n);else if(s>0){const l=Math.min(Math.max(C,E||0),T);e=Math.min(l,b+n)}e!==b&&ct(e)},[b,C,T,E]),at=y>C,rt=y<Math.min(E,T),J=f.useRef(new Set);f.useEffect(()=>{if(!p||!$||!R)return;const t=u&&u.length>0?u[u.length-1]:null;if(!t||!t.closed)return;const s=Math.min($.length,R.length);if(s<2)return;const n=s-1,e=$[n-1],l=R[n-1],r=$[n],o=R[n];if(r==null||o==null||e==null||l==null)return;const c=e-l,i=r-o;let h=null;if(c<=0&&i>0?h="bull":c>=0&&i<0&&(h="bear"),h){const d=u&&u.length>0?u[u.length-1].time:Date.now(),m=`${d}:${h}`;if(!J.current.has(m)){J.current.add(m);try{p({type:h,time:d,price:u[u.length-1].close})}catch{}}}},[$,R,p,u]);const _=V.map(t=>Number(t.high)).filter(t=>isFinite(t)),G=V.map(t=>Number(t.low)).filter(t=>isFinite(t));if(_.length===0||G.length===0)return lt?a.jsx("div",{className:"meta",children:"Loading chart..."}):a.jsxs("div",{className:"meta",children:["No data for ",String(D)]});const it=Math.max(..._),Q=Math.min(...G);let N=(I-w*2)/(y-1||1),B=Math.max(1,N*.6);const X=w,ut=Math.max(w,Math.ceil(B/2)+1);N=(I-X-ut)/(y-1||1),B=Math.max(1,N*.6);const j=t=>w+(1-(t-Q)/(it-Q||1))*(H-w*2),tt=t=>{let s="";for(let n=0;n<t.length;n++){const e=t[n];if(e==null)continue;const l=w+n*N,r=j(e);s+=s===""?`M ${l} ${r}`:` L ${l} ${r}`}return s},et=tt(z),nt=tt(K),O=[];for(let t=1;t<y;t++){const s=z[t-1],n=K[t-1],e=z[t],l=K[t];if(e==null||l==null||s==null||n==null)continue;const r=s-n,o=e-l;if(r<=0&&o>0){const c=w+t*N,i=j((e+l)/2);O.push({x:c,y:i,type:"bull",idx:t})}else if(r>=0&&o<0){const c=w+t*N,i=j((e+l)/2);O.push({x:c,y:i,type:"bear",idx:t})}}return E===0?a.jsx("div",{className:"meta",children:"Loading chart..."}):a.jsxs("div",{onWheel:ot,style:{width:"100%",overflow:"hidden",cursor:at?"zoom-in":rt?"zoom-out":"default"},children:[a.jsxs("svg",{className:"chart-svg",viewBox:`0 0 ${I} ${H}`,preserveAspectRatio:"xMidYMid meet",style:{width:"100%",height:"auto",display:"block"},children:[V.map((t,s)=>{if(![t.open,t.high,t.low,t.close].every(m=>isFinite(Number(m))))return null;const n=X+s*N,e=j(t.high),l=j(t.low),r=j(t.open),o=j(t.close),i=t.close>=t.open?"#0f9d58":"#d93025",h=Math.min(r,o),d=Math.max(1,Math.abs(o-r));return a.jsxs("g",{children:[a.jsx("line",{x1:n,x2:n,y1:e,y2:l,stroke:i,strokeWidth:1}),a.jsx("rect",{x:n-B/2,y:h,width:B,height:d,fill:i})]},t.time)}),nt&&a.jsx("path",{className:"ema200",d:nt,fill:"none",stroke:"#888",strokeWidth:1.2}),et&&a.jsx("path",{className:"ema26",d:et,fill:"none",stroke:"#ff9900",strokeWidth:1.6}),O.map((t,s)=>a.jsx("circle",{className:"cross-marker "+(t.type==="bull"?"bull":"bear"),cx:t.x,cy:t.y,r:4},s))]}),a.jsxs("div",{className:"chart-legend",children:[a.jsxs("span",{className:"legend-item",children:[a.jsx("span",{className:"swatch ema26"}),`EMA${g}`]}),a.jsxs("span",{className:"legend-item",children:[a.jsx("span",{className:"swatch ema200"}),`EMA${x}`]}),a.jsxs("span",{className:"legend-item",children:[a.jsx("span",{className:"swatch bull"}),"Bull Cross"]}),a.jsxs("span",{className:"legend-item",children:[a.jsx("span",{className:"swatch bear"}),"Bear Cross"]})]})]})}export{mt as default};
