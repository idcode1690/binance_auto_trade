import{r as f,j as a}from"./index-BN54sUn6.js";function lt(S,$){const F=2/($+1),M=[];let p=null;for(let g=0;g<S.length;g++){const x=S[g];if(x==null){M.push(null);continue}p==null?p=x:p=x*F+p*(1-F),M.push(p)}return M}function pt({interval:S="1m",limit:$=200,livePrice:F=null,onTrade:M=null,onCross:p=null,emaShort:g=26,emaLong:x=200,symbol:D="BTCUSDT",useTestnet:H=!1}){const[u,W]=f.useState([]),[ot,P]=f.useState(!0),[R,J]=f.useState([]),[L,_]=f.useState([]),v=f.useRef(null),U=f.useRef(null);f.useEffect(()=>{let t=!1,s=null;async function e(){P(!0);try{const c=`${H?"https://testnet.binance.vision":"https://api.binance.com"}/api/v3/klines?symbol=${encodeURIComponent(D)}&interval=${S}&limit=${$}`,o=(await(await fetch(c)).json()).map(r=>({open:parseFloat(r[1]),high:parseFloat(r[2]),low:parseFloat(r[3]),close:parseFloat(r[4]),closed:!0,time:r[0]}));if(t)return;W(o),P(!1)}catch(n){console.warn("fetch klines failed",n),W([]),P(!1)}}try{const n=String(D||"BTCUSDT").toLowerCase(),c=`${n}@kline_${S}/${n}@trade`,l=`${H?"wss://testnet.binance.vision":"wss://stream.binance.com:9443"}/stream?streams=${c}`;s=new WebSocket(l),s.onmessage=o=>{try{const r=JSON.parse(o.data),h=r.data||r;if(h&&h.k){const m=h.k,d={open:parseFloat(m.o),high:parseFloat(m.h),low:parseFloat(m.l),close:parseFloat(m.c),time:m.t,closed:!!m.x};W(b=>{if(!b||b.length===0)return[d];if(b[b.length-1].time===d.time){const E=b.slice(0,b.length-1);return E.push(d),E}else{const E=b.concat([d]);return E.length>$&&E.shift(),E}});return}if(h&&(h.p||h.price)){const m=parseFloat(h.p||h.price||h.P);if(M&&isFinite(m))try{M(m)}catch{}}}catch{}},s.onerror=o=>console.warn("combined ws error",o)}catch(n){console.warn("failed to open combined websocket",n)}return e(),()=>{t=!0;try{s&&s.close()}catch{}}},[S,$,D,M]),f.useEffect(()=>{if(!u||u.length===0)return;const t=u.map(n=>n.close),s=lt(t,g),e=lt(t,x);J(s),_(e),v.current=s.length?s[s.length-1]:null,U.current=e.length?e[e.length-1]:null},[u,g,x]);const I=f.useRef(null),A=f.useRef(null);f.useEffect(()=>{if(F==null)return;const t=Number(F);if(isFinite(t))return I.current=t,A.current==null&&(A.current=requestAnimationFrame(()=>{const s=I.current;I.current=null,A.current=null,W(e=>{if(!e||e.length===0)return e;const n=e.slice(),c=n[n.length-1];if(!c)return e;const i={...c,close:s,high:Math.max(c.high,s),low:Math.min(c.low,s)};return n[n.length-1]=i,n});try{if(v.current!=null&&U.current!=null){const e=2/(g+1),n=2/(x+1),c=s*e+v.current*(1-e),i=s*n+U.current*(1-n);v.current=c,U.current=i,J(l=>{if(!l||l.length===0)return l;const o=l.slice();return o[o.length-1]=c,o}),_(l=>{if(!l||l.length===0)return l;const o=l.slice();return o[o.length-1]=i,o})}}catch{}})),()=>{A.current&&(cancelAnimationFrame(A.current),A.current=null)}},[F]);const V=600,z=160,w=2,B=u.length,[N,at]=f.useState(120),C=10,K=Math.max(C,$),y=Math.min(B,N),O=u.slice(-y),T=R.slice(-y),Z=L.slice(-y),rt=f.useCallback(t=>{try{t.preventDefault()}catch{}const s=t.deltaY,e=Math.max(1,Math.round(N*.12));let n=N;if(s<0)n=Math.max(C,N-e);else if(s>0){const c=Math.min(Math.max(C,B||0),K);n=Math.min(c,N+e)}n!==N&&at(n)},[N,C,K,B]),it=y>C,ut=y<Math.min(B,K),G=f.useRef(new Set);f.useEffect(()=>{if(!p||!R||!L)return;const t=u&&u.length>0?u[u.length-1]:null;if(!t||!t.closed)return;const s=Math.min(R.length,L.length);if(s<2)return;const e=s-1,n=R[e-1],c=L[e-1],i=R[e],l=L[e];if(i==null||l==null||n==null||c==null)return;const o=n-c,r=i-l;let h=null;if(o<=0&&r>0?h="bull":o>=0&&r<0&&(h="bear"),h){const m=u&&u.length>0?u[u.length-1].time:Date.now(),d=`${m}:${h}`;if(!G.current.has(d)){G.current.add(d);try{p({type:h,time:m,price:u[u.length-1].close})}catch{}}}},[R,L,p,u]);const Q=O.map(t=>Number(t.high)).filter(t=>isFinite(t)),X=O.map(t=>Number(t.low)).filter(t=>isFinite(t));if(Q.length===0||X.length===0)return ot?a.jsx("div",{className:"meta",children:"Loading chart..."}):a.jsxs("div",{className:"meta",children:["No data for ",String(D)]});const ht=Math.max(...Q),tt=Math.min(...X);let j=(V-w*2)/(y-1||1),Y=Math.max(1,j*.6);const et=w,ft=Math.max(w,Math.ceil(Y/2)+1);j=(V-et-ft)/(y-1||1),Y=Math.max(1,j*.6);const k=t=>w+(1-(t-tt)/(ht-tt||1))*(z-w*2),nt=t=>{let s="";for(let e=0;e<t.length;e++){const n=t[e];if(n==null)continue;const c=w+e*j,i=k(n);s+=s===""?`M ${c} ${i}`:` L ${c} ${i}`}return s},st=nt(T),ct=nt(Z),q=[];for(let t=1;t<y;t++){const s=T[t-1],e=Z[t-1],n=T[t],c=Z[t];if(n==null||c==null||s==null||e==null)continue;const i=s-e,l=n-c;if(i<=0&&l>0){const o=w+t*j,r=k((n+c)/2);q.push({x:o,y:r,type:"bull",idx:t})}else if(i>=0&&l<0){const o=w+t*j,r=k((n+c)/2);q.push({x:o,y:r,type:"bear",idx:t})}}return B===0?a.jsx("div",{className:"meta",children:"Loading chart..."}):a.jsxs("div",{onWheel:rt,style:{width:"100%",overflow:"hidden",cursor:it?"zoom-in":ut?"zoom-out":"default"},children:[a.jsxs("svg",{className:"chart-svg",viewBox:`0 0 ${V} ${z}`,preserveAspectRatio:"none",style:{width:"100%",height:z},children:[O.map((t,s)=>{if(![t.open,t.high,t.low,t.close].every(d=>isFinite(Number(d))))return null;const e=et+s*j,n=k(t.high),c=k(t.low),i=k(t.open),l=k(t.close),r=t.close>=t.open?"#0f9d58":"#d93025",h=Math.min(i,l),m=Math.max(1,Math.abs(l-i));return a.jsxs("g",{children:[a.jsx("line",{x1:e,x2:e,y1:n,y2:c,stroke:r,strokeWidth:1}),a.jsx("rect",{x:e-Y/2,y:h,width:Y,height:m,fill:r})]},t.time)}),ct&&a.jsx("path",{className:"ema200",d:ct,fill:"none",stroke:"#888",strokeWidth:1.2}),st&&a.jsx("path",{className:"ema26",d:st,fill:"none",stroke:"#ff9900",strokeWidth:1.6}),q.map((t,s)=>a.jsx("circle",{className:"cross-marker "+(t.type==="bull"?"bull":"bear"),cx:t.x,cy:t.y,r:4},s))]}),a.jsxs("div",{className:"chart-legend",children:[a.jsxs("span",{className:"legend-item",children:[a.jsx("span",{className:"swatch ema26"}),`EMA${g}`]}),a.jsxs("span",{className:"legend-item",children:[a.jsx("span",{className:"swatch ema200"}),`EMA${x}`]}),a.jsxs("span",{className:"legend-item",children:[a.jsx("span",{className:"swatch bull"}),"Bull Cross"]}),a.jsxs("span",{className:"legend-item",children:[a.jsx("span",{className:"swatch bear"}),"Bear Cross"]})]})]})}export{pt as default};
