import{r as f,j as o}from"./index-CCzO_WMS.js";function st(R,A){const k=2/(A+1),M=[];let g=null;for(let p=0;p<R.length;p++){const x=R[p];if(x==null){M.push(null);continue}g==null?g=x:g=x*k+g*(1-k),M.push(g)}return M}function mt({interval:R="1m",limit:A=200,livePrice:k=null,onTrade:M=null,onCross:g=null,emaShort:p=26,emaLong:x=200,symbol:B="BTCUSDT"}){const[u,O]=f.useState([]),[lt,C]=f.useState(!0),[S,Z]=f.useState([]),[$,q]=f.useState([]),T=f.useRef(null),W=f.useRef(null);f.useEffect(()=>{let t=null,n=null;try{const e="wss://fstream.binance.com",s=String(B||"BTCUSDT").toLowerCase(),l=`${s}@kline_${R}/${s}@trade`,i=`${e}/stream?streams=${l}`;t=new WebSocket(i),t.onopen=()=>{n=setTimeout(()=>{C(!1)},6e3)},t.onmessage=c=>{try{const r=JSON.parse(c.data),a=r.data||r;if(a&&a.k){C(!1);const h=a.k,d={open:parseFloat(h.o),high:parseFloat(h.h),low:parseFloat(h.l),close:parseFloat(h.c),time:h.t,closed:!!h.x};O(m=>{if(!m||m.length===0)return[d];if(m[m.length-1].time===d.time){const L=m.slice(0,m.length-1);return L.push(d),L}else{const L=m.concat([d]);return L.length>A&&L.shift(),L}});return}if(a&&(a.p||a.price)){const h=parseFloat(a.p||a.price||a.P);if(M&&isFinite(h))try{M(h)}catch{}}}catch{}},t.onerror=c=>{console.warn("combined ws error",c),n&&clearTimeout(n),C(!1)}}catch(e){console.warn("failed to open combined websocket",e),C(!1)}return()=>{n&&clearTimeout(n);try{t&&t.close()}catch{}}},[R,A,B,M]),f.useEffect(()=>{if(!u||u.length===0)return;const t=u.map(s=>s.close),n=st(t,p),e=st(t,x);Z(n),q(e),T.current=n.length?n[n.length-1]:null,W.current=e.length?e[e.length-1]:null},[u,p,x]);const P=f.useRef(null),F=f.useRef(null);f.useEffect(()=>{if(k==null)return;const t=Number(k);if(isFinite(t))return P.current=t,F.current==null&&(F.current=requestAnimationFrame(()=>{const n=P.current;P.current=null,F.current=null,O(e=>{if(!e||e.length===0)return e;const s=e.slice(),l=s[s.length-1];if(!l)return e;const i={...l,close:n,high:Math.max(l.high,n),low:Math.min(l.low,n)};return s[s.length-1]=i,s});try{if(T.current!=null&&W.current!=null){const e=2/(p+1),s=2/(x+1),l=n*e+T.current*(1-e),i=n*s+W.current*(1-s);T.current=l,W.current=i,Z(c=>{if(!c||c.length===0)return c;const r=c.slice();return r[r.length-1]=l,r}),q(c=>{if(!c||c.length===0)return c;const r=c.slice();return r[r.length-1]=i,r})}}catch{}})),()=>{F.current&&(cancelAnimationFrame(F.current),F.current=null)}},[k]);const U=600,H=160,w=2,E=u.length,[b,ct]=f.useState(120),D=10,v=Math.max(D,A),y=Math.min(E,b),V=u.slice(-y),z=S.slice(-y),I=$.slice(-y),ot=f.useCallback(t=>{try{t.preventDefault()}catch{}const n=t.deltaY,e=Math.max(1,Math.round(b*.12));let s=b;if(n<0)s=Math.max(D,b-e);else if(n>0){const l=Math.min(Math.max(D,E||0),v);s=Math.min(l,b+e)}s!==b&&ct(s)},[b,D,v,E]),rt=y>D,at=y<Math.min(E,v),J=f.useRef(new Set);f.useEffect(()=>{if(!g||!S||!$)return;const t=u&&u.length>0?u[u.length-1]:null;if(!t||!t.closed)return;const n=Math.min(S.length,$.length);if(n<2)return;const e=n-1,s=S[e-1],l=$[e-1],i=S[e],c=$[e];if(i==null||c==null||s==null||l==null)return;const r=s-l,a=i-c;let h=null;if(r<=0&&a>0?h="bull":r>=0&&a<0&&(h="bear"),h){const d=u&&u.length>0?u[u.length-1].time:Date.now(),m=`${d}:${h}`;if(!J.current.has(m)){J.current.add(m);try{g({type:h,time:d,price:u[u.length-1].close})}catch{}}}},[S,$,g,u]);const _=V.map(t=>Number(t.high)).filter(t=>isFinite(t)),G=V.map(t=>Number(t.low)).filter(t=>isFinite(t));if(_.length===0||G.length===0)return lt?o.jsx("div",{className:"meta",children:"Loading chart..."}):o.jsxs("div",{className:"meta",children:["No data for ",String(B)]});const it=Math.max(..._),Q=Math.min(...G);let N=(U-w*2)/(y-1||1),Y=Math.max(1,N*.6);const X=w,ut=Math.max(w,Math.ceil(Y/2)+1);N=(U-X-ut)/(y-1||1),Y=Math.max(1,N*.6);const j=t=>w+(1-(t-Q)/(it-Q||1))*(H-w*2),tt=t=>{let n="";for(let e=0;e<t.length;e++){const s=t[e];if(s==null)continue;const l=w+e*N,i=j(s);n+=n===""?`M ${l} ${i}`:` L ${l} ${i}`}return n},et=tt(z),nt=tt(I),K=[];for(let t=1;t<y;t++){const n=z[t-1],e=I[t-1],s=z[t],l=I[t];if(s==null||l==null||n==null||e==null)continue;const i=n-e,c=s-l;if(i<=0&&c>0){const r=w+t*N,a=j((s+l)/2);K.push({x:r,y:a,type:"bull",idx:t})}else if(i>=0&&c<0){const r=w+t*N,a=j((s+l)/2);K.push({x:r,y:a,type:"bear",idx:t})}}return E===0?o.jsx("div",{className:"meta",children:"Loading chart..."}):o.jsxs("div",{onWheel:ot,style:{width:"100%",overflow:"hidden",cursor:rt?"zoom-in":at?"zoom-out":"default"},children:[o.jsxs("svg",{className:"chart-svg",viewBox:`0 0 ${U} ${H}`,preserveAspectRatio:"xMidYMid meet",style:{width:"100%",height:"auto",display:"block"},children:[V.map((t,n)=>{if(![t.open,t.high,t.low,t.close].every(m=>isFinite(Number(m))))return null;const e=X+n*N,s=j(t.high),l=j(t.low),i=j(t.open),c=j(t.close),a=t.close>=t.open?"#0f9d58":"#d93025",h=Math.min(i,c),d=Math.max(1,Math.abs(c-i));return o.jsxs("g",{children:[o.jsx("line",{x1:e,x2:e,y1:s,y2:l,stroke:a,strokeWidth:1}),o.jsx("rect",{x:e-Y/2,y:h,width:Y,height:d,fill:a})]},t.time)}),nt&&o.jsx("path",{className:"ema200",d:nt,fill:"none",stroke:"#888",strokeWidth:1.2}),et&&o.jsx("path",{className:"ema26",d:et,fill:"none",stroke:"#ff9900",strokeWidth:1.6}),K.map((t,n)=>o.jsx("circle",{className:"cross-marker "+(t.type==="bull"?"bull":"bear"),cx:t.x,cy:t.y,r:4},n))]}),o.jsxs("div",{className:"chart-legend",children:[o.jsxs("span",{className:"legend-item",children:[o.jsx("span",{className:"swatch ema26"}),`EMA${p}`]}),o.jsxs("span",{className:"legend-item",children:[o.jsx("span",{className:"swatch ema200"}),`EMA${x}`]}),o.jsxs("span",{className:"legend-item",children:[o.jsx("span",{className:"swatch bull"}),"Bull Cross"]}),o.jsxs("span",{className:"legend-item",children:[o.jsx("span",{className:"swatch bear"}),"Bear Cross"]})]})]})}export{mt as default};
