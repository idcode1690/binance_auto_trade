import{r as u,j as a}from"./index-yOfe0ryP.js";function nt(M,k){const S=2/(k+1),w=[];let p=null;for(let g=0;g<M.length;g++){const x=M[g];if(x==null){w.push(null);continue}p==null?p=x:p=x*S+p*(1-S),w.push(p)}return w}function ht({interval:M="1m",limit:k=200,livePrice:S=null,onTrade:w=null,onCross:p=null,emaShort:g=26,emaLong:x=200,symbol:D="BTCUSDT"}){const[h,W]=u.useState([]),[st,B]=u.useState(!0),[F,Z]=u.useState([]),[$,q]=u.useState([]),U=u.useRef(null),Y=u.useRef(null);u.useEffect(()=>{let t=!1,n=null;async function s(){B(!0);try{const e=`https://api.binance.com/api/v3/klines?symbol=${encodeURIComponent(D)}&interval=${M}&limit=${k}`,l=(await(await fetch(e)).json()).map(o=>({open:parseFloat(o[1]),high:parseFloat(o[2]),low:parseFloat(o[3]),close:parseFloat(o[4]),time:o[0]}));if(t)return;W(l),B(!1)}catch(e){console.warn("fetch klines failed",e),W([]),B(!1)}}try{const e=String(D||"BTCUSDT").toLowerCase(),i=`wss://stream.binance.com:9443/stream?streams=${`${e}@kline_${M}/${e}@trade`}`;n=new WebSocket(i),n.onmessage=l=>{try{const o=JSON.parse(l.data),r=o.data||o;if(r&&r.k){const f=r.k,m={open:parseFloat(f.o),high:parseFloat(f.h),low:parseFloat(f.l),close:parseFloat(f.c),time:f.t};W(d=>{if(!d||d.length===0)return[m];if(d[d.length-1].time===m.time){const A=d.slice(0,d.length-1);return A.push(m),A}else{const A=d.concat([m]);return A.length>k&&A.shift(),A}});return}if(r&&(r.p||r.price)){const f=parseFloat(r.p||r.price||r.P);if(w&&isFinite(f))try{w(f)}catch{}}}catch{}},n.onerror=l=>console.warn("combined ws error",l)}catch(e){console.warn("failed to open combined websocket",e)}return s(),()=>{t=!0;try{n&&n.close()}catch{}}},[M,k,D,w]),u.useEffect(()=>{if(!h||h.length===0)return;const t=h.map(e=>e.close),n=nt(t,g),s=nt(t,x);Z(n),q(s),U.current=n.length?n[n.length-1]:null,Y.current=s.length?s[s.length-1]:null},[h,g,x]);const P=u.useRef(null),R=u.useRef(null);u.useEffect(()=>{if(S==null)return;const t=Number(S);if(isFinite(t))return P.current=t,R.current==null&&(R.current=requestAnimationFrame(()=>{const n=P.current;P.current=null,R.current=null,W(s=>{if(!s||s.length===0)return s;const e=s.slice(),c=e[e.length-1];if(!c)return s;const i={...c,close:n,high:Math.max(c.high,n),low:Math.min(c.low,n)};return e[e.length-1]=i,e});try{if(U.current!=null&&Y.current!=null){const s=2/(g+1),e=2/(x+1),c=n*s+U.current*(1-s),i=n*e+Y.current*(1-e);U.current=c,Y.current=i,Z(l=>{if(!l||l.length===0)return l;const o=l.slice();return o[o.length-1]=c,o}),q(l=>{if(!l||l.length===0)return l;const o=l.slice();return o[o.length-1]=i,o})}}catch{}})),()=>{R.current&&(cancelAnimationFrame(R.current),R.current=null)}},[S]);const H=600,v=160,y=2,E=h.length,[b,ct]=u.useState(120),L=10,I=Math.max(L,k),N=Math.min(E,b),T=h.slice(-N),V=F.slice(-N),z=$.slice(-N),ot=u.useCallback(t=>{try{t.preventDefault()}catch{}const n=t.deltaY,s=Math.max(1,Math.round(b*.12));let e=b;if(n<0)e=Math.max(L,b-s);else if(n>0){const c=Math.min(Math.max(L,E||0),I);e=Math.min(c,b+s)}e!==b&&ct(e)},[b,L,I,E]),lt=N>L,rt=N<Math.min(E,I),J=u.useRef(new Set);u.useEffect(()=>{if(!p||!F||!$)return;const t=Math.min(F.length,$.length);if(t<2)return;const n=t-1,s=F[n-1],e=$[n-1],c=F[n],i=$[n];if(c==null||i==null||s==null||e==null)return;const l=s-e,o=c-i;let r=null;if(l<=0&&o>0?r="bull":l>=0&&o<0&&(r="bear"),r){const f=h&&h.length>0?h[h.length-1].time:Date.now(),m=`${f}:${r}`;if(!J.current.has(m)){J.current.add(m);try{p({type:r,time:f,price:h[h.length-1].close})}catch{}}}},[F,$,p,h]);const K=T.map(t=>Number(t.high)).filter(t=>isFinite(t)),_=T.map(t=>Number(t.low)).filter(t=>isFinite(t));if(K.length===0||_.length===0)return st?a.jsx("div",{className:"meta",children:"Loading chart..."}):a.jsxs("div",{className:"meta",children:["No data for ",String(D)]});const at=Math.max(...K),G=Math.min(..._),C=(H-y*2)/(N-1||1),Q=Math.max(1,C*.6),j=t=>y+(1-(t-G)/(at-G||1))*(v-y*2),X=t=>{let n="";for(let s=0;s<t.length;s++){const e=t[s];if(e==null)continue;const c=y+s*C,i=j(e);n+=n===""?`M ${c} ${i}`:` L ${c} ${i}`}return n},tt=X(V),et=X(z),O=[];for(let t=1;t<N;t++){const n=V[t-1],s=z[t-1],e=V[t],c=z[t];if(e==null||c==null||n==null||s==null)continue;const i=n-s,l=e-c;if(i<=0&&l>0){const o=y+t*C,r=j((e+c)/2);O.push({x:o,y:r,type:"bull",idx:t})}else if(i>=0&&l<0){const o=y+t*C,r=j((e+c)/2);O.push({x:o,y:r,type:"bear",idx:t})}}return E===0?a.jsx("div",{className:"meta",children:"Loading chart..."}):a.jsxs("div",{onWheel:ot,style:{width:"100%",overflow:"hidden",cursor:lt?"zoom-in":rt?"zoom-out":"default"},children:[a.jsxs("svg",{className:"chart-svg",viewBox:`0 0 ${H} ${v}`,preserveAspectRatio:"none",style:{width:"100%",height:v},children:[T.map((t,n)=>{if(![t.open,t.high,t.low,t.close].every(d=>isFinite(Number(d))))return null;const s=y+n*C,e=j(t.high),c=j(t.low),i=j(t.open),l=j(t.close),r=t.close>=t.open?"#0f9d58":"#d93025",f=Math.min(i,l),m=Math.max(1,Math.abs(l-i));return a.jsxs("g",{children:[a.jsx("line",{x1:s,x2:s,y1:e,y2:c,stroke:r,strokeWidth:1}),a.jsx("rect",{x:s-Q/2,y:f,width:Q,height:m,fill:r})]},t.time)}),et&&a.jsx("path",{className:"ema200",d:et,fill:"none",stroke:"#888",strokeWidth:1.2}),tt&&a.jsx("path",{className:"ema26",d:tt,fill:"none",stroke:"#ff9900",strokeWidth:1.6}),O.map((t,n)=>a.jsx("circle",{className:"cross-marker "+(t.type==="bull"?"bull":"bear"),cx:t.x,cy:t.y,r:4},n))]}),a.jsxs("div",{className:"chart-legend",children:[a.jsxs("span",{className:"legend-item",children:[a.jsx("span",{className:"swatch ema26"}),`EMA${g}`]}),a.jsxs("span",{className:"legend-item",children:[a.jsx("span",{className:"swatch ema200"}),`EMA${x}`]}),a.jsxs("span",{className:"legend-item",children:[a.jsx("span",{className:"swatch bull"}),"Bull Cross"]}),a.jsxs("span",{className:"legend-item",children:[a.jsx("span",{className:"swatch bear"}),"Bear Cross"]})]})]})}export{ht as default};
